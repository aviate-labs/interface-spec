<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<meta name="author" content="Joachim Breitner">
<title>Public specification of the Internet Computer</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Public specification of the Internet Computer</h1>
<div class="details">
<span id="author" class="author">Joachim Breitner</span><br>
<span id="email" class="email"><a href="mailto:joachim@dfinity.org">joachim@dfinity.org</a></span><br>
<span id="revdate">0.3 (unreleased)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preamble">Preamble</a>
<ul class="sectlevel2">
<li><a href="#_status">Status</a></li>
<li><a href="#_process">Process</a></li>
</ul>
</li>
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_scope_of_this_document">Scope of this document</a></li>
<li><a href="#_overview_of_the_internet_computer">Overview of the Internet Computer</a></li>
<li><a href="#_nomenclature">Nomenclature</a></li>
</ul>
</li>
<li><a href="#_principal_ids">Principal IDs</a>
<ul class="sectlevel2">
<li><a href="#id-classes">Special forms of IDs</a></li>
<li><a href="#textual-ids">Textual representation of principal ids</a></li>
</ul>
</li>
<li><a href="#http-interface">HTTPS Interface</a>
<ul class="sectlevel2">
<li><a href="#_submitting_vs_reading_requests">Submitting vs. reading requests</a>
<ul class="sectlevel3">
<li><a href="#async-requests">Asynchronous requests</a></li>
<li><a href="#_synchronous_requests">Synchronous requests</a></li>
<li><a href="#api-endpoints">Request Endpoints</a></li>
</ul>
</li>
<li><a href="#field-types">Field types</a></li>
<li><a href="#_common_fields">Common fields</a></li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#request-types">Request types</a>
<ul class="sectlevel3">
<li><a href="#api-create-canister">Canister creation</a></li>
<li><a href="#api-install-code">Canister code installation</a></li>
<li><a href="#api-controllers">Canister controller managemnet</a></li>
<li><a href="#api-update">Canister update call</a></li>
<li><a href="#api-request-status">Request status</a></li>
<li><a href="#api-query">Canister query call</a></li>
</ul>
</li>
<li><a href="#api-request-id">Request ids</a></li>
<li><a href="#reject-codes">Reject codes</a></li>
<li><a href="#api-status">Status endpoint</a></li>
<li><a href="#api-cbor">CBOR encoding of requests and responses</a></li>
<li><a href="#_ordering_guarantees">Ordering guarantees</a></li>
<li><a href="#_synchronicity_across_nodes">Synchronicity across nodes</a></li>
</ul>
</li>
<li><a href="#canister-module-format">Canister module format</a></li>
<li><a href="#system-api">Canister interface (System API)</a>
<ul class="sectlevel2">
<li><a href="#system-api-module">WebAssembly module requirements</a></li>
<li><a href="#_interpretation_of_numbers">Interpretation of numbers</a></li>
<li><a href="#_entry_points">Entry points</a>
<ul class="sectlevel3">
<li><a href="#system-api-init">Canister initializaion</a></li>
<li><a href="#system-api-upgrades">Canister upgrades</a></li>
<li><a href="#system-api-requests">Public methods</a></li>
<li><a href="#_callbacks">Callbacks</a></li>
</ul>
</li>
<li><a href="#_overview_of_imports">Overview of imports</a></li>
<li><a href="#_method_arguments">Method arguments</a></li>
<li><a href="#_responding">Responding</a></li>
<li><a href="#system-api-canister-self">Self-identification</a></li>
<li><a href="#system-api-call">Inter-canister method calls</a></li>
<li><a href="#system-api-stable-memory">Stable memory</a></li>
<li><a href="#_debugging_aids">Debugging aids</a></li>
<li><a href="#host-references">Outlook: Using Host References</a></li>
</ul>
</li>
<li><a href="#public-spec">Abstract public behavior</a>
<ul class="sectlevel2">
<li><a href="#_notation">Notation</a></li>
<li><a href="#_abstract_state">Abstract state</a>
<ul class="sectlevel3">
<li><a href="#_identifiers">Identifiers</a></li>
<li><a href="#abstract-canisters">Abstract canisters</a></li>
<li><a href="#_call_contexts">Call contexts</a></li>
<li><a href="#_calls_and_messages">Calls and Messages</a></li>
<li><a href="#_api_requests">API requests</a></li>
<li><a href="#_the_system_state">The system state</a></li>
<li><a href="#_initial_state">Initial state</a></li>
</ul>
</li>
<li><a href="#_state_transitions">State transitions</a>
<ul class="sectlevel3">
<li><a href="#_api_request_submission">API Request submission</a></li>
<li><a href="#_request_rejection">Request rejection</a></li>
<li><a href="#_canister_creation">Canister creation</a></li>
<li><a href="#_canister_code_installation">Canister code installation</a></li>
<li><a href="#_canister_code_upgrade">Canister code upgrade</a></li>
<li><a href="#_canister_controller_management">Canister controller management</a></li>
<li><a href="#_initiating_canister_calls">Initiating canister calls</a></li>
<li><a href="#_call_context_creation">Call context creation</a></li>
<li><a href="#_message_execution_non_trapping">Message execution (non-trapping)</a></li>
<li><a href="#_message_execution_trapping">Message execution (trapping)</a></li>
<li><a href="#_message_execution_double_response">Message execution (double response)</a></li>
<li><a href="#_call_context_starvation">Call context starvation</a></li>
<li><a href="#_callback_invocation">Callback invocation</a></li>
<li><a href="#_respond_to_user_request">Respond to user request</a></li>
<li><a href="#_request_clean_up">Request clean up</a></li>
<li><a href="#_read_status">Read: Status</a></li>
<li><a href="#_read_query_call">Read: query call</a></li>
</ul>
</li>
<li><a href="#concrete-canisters">Abstract Canisters to System API</a>
<ul class="sectlevel3">
<li><a href="#_the_concrete_wasmstate">The concrete <code>WasmState</code></a></li>
<li><a href="#_the_execution_state">The execution state</a></li>
<li><a href="#_the_concrete_canistermodule">The concrete <code>CanisterModule</code></a></li>
<li><a href="#_helper_functions">Helper functions</a></li>
<li><a href="#_system_imports">System imports</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#changelog">Changelog</a>
<ul class="sectlevel2">
<li><a href="#v0_3">0.3 (unreleased)</a></li>
<li><a href="#v0_2_0_4">0.2.0.4 (unreleased)</a></li>
<li><a href="#v0_2_0_2">0.2.0.2 (2020-03-19)</a></li>
<li><a href="#v0_2_0_0">0.2.0.0 (2020-03-11)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preamble">Preamble</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document describes the public interface of the Internet Computer. It is the authoritative source for interface details (request and function names, parameters, encodings). The goal is to have a document that is authoritative, and provides a place and a language to discuss public features of the Internet Computer in a hopefully concrete way. It could also be a document that we can publish to users of the Internet Computer.</p>
</div>
<div class="paragraph">
<p>Because of its focus on the externally visible behavior of the Internet Computer, it will also help uncover abstraction leaks. Because it aims to describe the full behavior, it helps to show which designs are unexpectedly complicated or don’t go well together. But as it intentionally does not address <em>how</em> to implement this behaviour, it cannot be used as an implementation spec.</p>
</div>
<div class="sect2">
<h3 id="_status">Status</h3>
<div class="paragraph">
<p>The <code>master</code> version of this document corresponds to <em>approved</em> designs. It does, however, <em>not</em> indicate any kind of implementation plan, and must not be used as an implementation specification. It may contain features that are not yet implemented, the implementation plans are made elsewhere.</p>
</div>
<div class="paragraph">
<p>Aspects of this document not implemented in the master version of the official internet computer are labeled as such, using the “warning” admonition.</p>
</div>
<div class="paragraph">
<p>Please skim the <a href="https://github.com/dfinity-lab/dfinity/pulls?q=is%3Apr+is%3Aopen+%22Public+Spec%22+in%3Atitle">list of open PRs</a> against this document, to get an overview of ongoing discussions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_process">Process</h3>
<div class="paragraph">
<p>This document is maintained by its editors (currently Joachim, Jens, Björn). The editors drive its evolution, make sure the right process is followed and try to keep tabs on relevant design discussions happening. Nevertheless, everyone is invited to contribute.</p>
</div>
<div class="paragraph">
<p>A proposed change of this document should take the form of a Pull Request on GitHub, be titled “Public Spec: <em>title</em>”, and its description should answer the following questions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How is this change mandated by the design: Which design slides is this based on, and – if not immediate – why do these slides imply the present change. This may initially refer to not-yet-approved slides, if the slides and the interface of a feature are developed side-by-side.</p>
</li>
<li>
<p>Which parties (Replica, Languages, SDK, Research) are affected by this change, and why?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Such a change can be merged if</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The design slides mentioned above are actually approved.</p>
</li>
<li>
<p>A lead or representative of each involved party approves the change.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>An Editor, who did not initiate the change, should check these requirements.</p>
</div>
<div class="paragraph">
<p>Purely editorial changes can be merged by the editors directly. Generally, these merges should be “squash merges”.</p>
</div>
<div class="paragraph">
<p>Draft PRs can be used for experimentation and exploration without any process requirement.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Welcome to the Internet Computer! We speak of “the” Internet Computer, because although under the hood, a large number of physical computers are working together in non-trivial ways, in the end we have the appearance of a single, shared, secure and world-wide accessible computer. Much, if not all, of the advanced and complex machinery is hidden from those that use the Internet Computer to run their applications and those who use these applications.</p>
</div>
<div class="sect2">
<h3 id="_scope_of_this_document">Scope of this document</h3>
<div class="paragraph">
<p>This documents describes this external view of the Internet Computer:
Which interfaces it provides to application developers and users, and what will happen when you use these interfaces.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
While this document describes the public interface and behavior of the Internet Computer, it is not the primary end-user documentation. The creators of the Internet Computer provide further tools, such as the Motoko programming language, the IDL tooling and the SDK tools, to make programming and using the Internet Computer even more convenient.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you think of the Internet Computer as a distributed execution engine that <em>provides</em> a WebAssembly-based application hosting service, then this document describes exclusively the latter aspect of it. So to the extent possible, this document will <em>not</em> talk about blockchain, consensus protocols, nodes, subnets and orthogonal persistence.</p>
</div>
<div class="paragraph">
<p>This document tries to be implementation agnostic: If we decide to re-do the implementation of the Internet Computer from scratch at some point in the future, then this document would (ideally) still be valid as is.</p>
</div>
<div class="paragraph">
<p>This implies that this document does not speak of the interface of the Internet Computer towards its engineers and administrators, as topics like node update, monitoring, logging are inherently tied to the actual <em>implementation</em> and its architecture.</p>
</div>
</div>
<div class="sect2">
<h3 id="_overview_of_the_internet_computer">Overview of the Internet Computer</h3>
<div class="paragraph">
<p>If you want to use the Internet Computer as an application developer, you first create a <em>canister module</em> that contains the WebAssembly code and configuration for your application, and deploy it using the <a href="#http-interface">public HTTP interface</a>. You can create canisters using the Motoko language and the SDK, which is more convenient. If you want to use your own tooling, however, then this document describes <a href="#canister-module-format">how a canister module looks like</a> and how the <a href="#system-api">WebAssembly code can interact with the system</a>.</p>
</div>
<div class="paragraph">
<p>Once your application is running on the Internet Computer, it is a <em>canister</em>, and users can interact with it. They can use the <a href="#http-interface">public HTTP interface</a> to interact with the canister according to the <a href="#system-api">System API</a>.</p>
</div>
<div class="paragraph">
<p>The user can also use the HTTP interface to issue read-only queries, which are faster, but cannot change the state of a canister.</p>
</div>
<div class="literalblock">
<div class="title">A typical use of the Internet Computer. (This is a simplified view; some of the arrows represent multiple interaction steps or polling.)</div>
<div class="content">
<pre>actor Developer
actor User
participant "Internet Computer" as IC
participant "Canister 1" as Can1
Developer -&gt; IC : /submit create canister
create Can1
IC -&gt; Can1 : create
Developer &lt;-- IC : canister-id=1
Developer -&gt; IC : /submit install module
IC -&gt; Can1 : initialize
|||
User -&gt; IC : /submit call “hello”
IC -&gt; Can1 : hello
return "Hello world!"
User &lt;-- IC : "Hello World!"</pre>
</div>
</div>
<div class="paragraph">
<p>Sections “<a href="#http-interface">HTTPS Interface</a>” and “<a href="#system-api">Canister interface (System API)</a>” describe these interfaces, together with a brief description of what they do. Afterwards, you will find a <a href="#public-spec">more formal description</a> of the Internet Computer that describes its abstract behavior with high precision.</p>
</div>
</div>
<div class="sect2">
<h3 id="_nomenclature">Nomenclature</h3>
<div class="paragraph">
<p>To get some consistency in this document, we try to use the following terms with precision:</p>
</div>
<div class="paragraph">
<p>We avoid the term “client”, as it could be the client of the Internet Computer or the client inside the distributed network that makes up the Internet Computer. Instead, we use the term <em>user</em> to the external entity interacting with the internet computer, even if in most cases it will be some code acting on behalf of a (human) user.</p>
</div>
<div class="paragraph">
<p>The public entry points of canisters are called <em>methods</em>. Methods can be declared to be either <em>update methods</em> (state mutation is preserved) or <em>query methods</em> (state mutation is discarded, no further calls can be made).</p>
</div>
<div class="paragraph">
<p>Methods can be <em>called</em>, from <em>caller</em> to <em>callee</em>, and will eventually incur a <em>response</em> which is either a <em>reply</em> or a <em>reject</em>. A method may have <em>parameters</em>, which are provided with concrete <em>arguments</em> in a method call.</p>
</div>
<div class="paragraph">
<p>Inter-canister calls do not distinguish between update and query methods. External calls can be update calls, which can call both kinds of methods, and query calls, which can <em>only</em> call query methods.</p>
</div>
<div class="paragraph">
<p>Internally, a call or a response is transmitted as a <em>message</em> from a <em>sender</em> to a <em>receiver</em>. Messages do not have a response.</p>
</div>
<div class="paragraph">
<p>WebAssembly  <em>functions</em> are exported by the WebAssembly module or provided by the System API. These are <em>invoked</em> and can either <em>trap</em> or <em>return</em>, possibly with a return value. Functions, too, have parameters and take arguments.</p>
</div>
<div class="paragraph">
<p>External <em>users</em> interact with the system by issuing <em>requests</em> on the HTTPS interface. Requests have responses which can either be replies or rejects. Some requests cause internal messages to be created.</p>
</div>
<div class="paragraph">
<p>Canisters, users, etc. are <em>principals</em>, and are identified by an <em>id</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_principal_ids">Principal IDs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Principal ids, like canister ids and user ids, are – as far as most uses of the system is concerned – binary blobs. There is, however, some structure to them to encode specific authentication and authorization behavior.</p>
</div>
<div class="sect2">
<h3 id="id-classes">Special forms of IDs</h3>
<div class="paragraph">
<p>There are three classes of ids:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Opaque ids</em>.</p>
<div class="paragraph">
<p>These are always generated by the system and have no structure of interest outside the system.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Typically, these end with the byte <code>0x01</code>, but users of the IC should not need to care about that.
</td>
</tr>
</table>
</div>
</li>
<li>
<p><em>Self-authenticating ids</em>.</p>
<div class="paragraph">
<p>These have the form <code>H(public_key) · 0x02</code>.</p>
</div>
<div class="paragraph">
<p>An external user can use these ids as the <code>sender</code> of a request if they own the corresponding private key.  See for example <a href="#authentication">Authentication</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the future the system may gain the ability to change the authentication rules for self-authenticating ids, e.g. revoke the original key and configure another one.
</td>
</tr>
</table>
</div>
</li>
<li>
<p><em>Derived ids</em></p>
<div class="paragraph">
<p>These have the form <code>H(registering_principal) · (arbitrary 8 bytes) · 0x03</code>.</p>
</div>
<div class="paragraph">
<p>These ids are treated specially when an id needs to be registered. In such a request, the caller (an user or a canister) may indicate a desired id of this form, if <code>registering_principal</code> is his own id. See for example <a href="#api-create-canister">Canister creation</a>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The hash function <code>H(…)</code> here is SHA-256. Thus self-authenticating ids are always 33 bytes long, derived ids are always 41 bytes long.</p>
</div>
<div class="paragraph">
<p>When the system creates a <em>fresh</em> id, it never uses a self-authenticating or derived id.</p>
</div>
</div>
<div class="sect2">
<h3 id="textual-ids">Textual representation of principal ids</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This textual representation does not actually show up in the interface (which always deals with blobs), so it is merely a recommended convention.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We specify a <em>canonical textual format</em> that is recommended whenever principal ids need to be printed or read in textual format, e.g. in log messages, transactions browser, command line tools, source code.</p>
</div>
<div class="paragraph">
<p>To turn a blob into the recognizable text format,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Append a one byte checksum, calculated using CRC-8 with polynomial 0x07 (MSB-first code).</p>
</li>
<li>
<p>Convert into hexadecimal form, with capital letters.</p>
</li>
<li>
<p>Prepend <code>ic:</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The canister with id <code>0xABCD01</code> becomes <code>ic:ABCD01A7</code> (<a href="https://crccalc.com/?crc=ABCD01&amp;method=crc8&amp;datatype=hex&amp;outtype=hex">online calculator</a>).
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="http-interface">HTTPS Interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The concrete mechanism that users use to send requests to the Internet Computer is via an HTTPS API, which exposes two endpoints to handle the requests, plus one for diagnostics.</p>
</div>
<div class="sect2">
<h3 id="_submitting_vs_reading_requests">Submitting vs. reading requests</h3>
<div class="literalblock">
<div class="title">The classification of requests, with example request types.</div>
<div class="content">
<pre>object "API Requests" as request

together {
object "Async" as async {
{field} May change system state
{field} Response via status polling
}

object "Sync" as sync {
{field} Cannot change state
{field} Immediate response
}
}

object "Certified" as certified {
provided by the “system”
}
object "Uncertified" as uncertified {
provided by the “node”
}

together {
 object "Canister installation" as install
 object "Canister update call" as call
 object "Canister query call" as query
 object "Read request status" as status
 object "Read account balance" as balance
}

request &lt;|-- async
request &lt;|-- sync
sync &lt;|-- certified
sync &lt;|-- uncertified

async &lt;|-- install
async &lt;|-- call

uncertified &lt;|-- query
certified &lt;|-- balance
certified &lt;|-- status</pre>
</div>
</div>
<div class="sect3">
<h4 id="async-requests">Asynchronous requests</h4>
<div class="paragraph">
<p>Certain interactions change the state of the Internet Computer. By the very nature of a distributed implementation, they cannot be acted upon immediately, but only with a delay. Moreover, the actual node that the user talks to may not be honest or, for other reasons, may fail to get the request on the way. This implies the following high-level workflow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A user submits a request via the <a href="#http-interface">HTTPS Interface</a>. No useful information is returned from the node (as it would not be trustworthy anyways).</p>
</li>
<li>
<p>For a certain amount of time, the system behaves as if it does not know about the request. (Althought as part of the RPC the receiving endpoint gives an untrusted acknowledgment of receipt or an untrusted declination of the request.)</p>
</li>
<li>
<p>At some point, the system may accept the request for processing (or it expires). From now on, the user can ask any RPC endpoint (for the canister) about the status of the pending request. Initially, the status is <code>received</code>: The system as a whole (not just a single node) has received the request, but it may still decide not to perform it, e.g. because of high load.</p>
</li>
<li>
<p>Once it is clear that the request will be acted upon, the status changes to <code>processing</code>. Now the user has the guarantee that the request will have an effect (e.g. in the case of a canister call, that it will reach the canister).</p>
</li>
<li>
<p>Now the system is processing the request. For some requests this may be atomic, for others this involves multiple internal steps.</p>
</li>
<li>
<p>Eventually, a response will be produced, and can be retrieved for a certain amount of time. The response is either a <code>reply</code>, indicating success, or a <code>reject</code>, indicating some form of error.</p>
</li>
<li>
<p>At the end, the system forgets about the request and its response.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This yields the following interaction diagram:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(*) --&gt; "User creates request" #DDDDDD
   --&gt; "Submitted to node" #DDDDDD
   --&gt; "Received"
   --&gt; "Processing"
if "" as X then
  --&gt; "Replied"
  --&gt; "Cleaned" #DDDDDD
  else
  --&gt; "Rejected (canister)"
  --&gt; "Cleaned" #DDDDDD

  "X"        --&gt; "Rejected (system)"
  "Received" --&gt; "Rejected (system)"
             --&gt; "Cleaned" #DDDDDD
endif</pre>
</div>
</div>
<div class="paragraph">
<p>Note that all gray states are <em>not</em> represented in the system state, and are indistinguishable from “request does not exist”. In order to avoid replay-attacks, messages have an expiry date, and the last transition (forgetting the message) must happen after the message’s expiry field invalidates it.</p>
</div>
<div class="paragraph">
<p>The crucial property of the <code>Received</code> state is <em>it is pointless (but harmless) to submit the (identical) request again</em>. Before reaching that state, submitting the identical request to further nodes might be a useful safeguard against a malicious or misbehaving node.</p>
</div>
<div class="paragraph">
<p>The crucial property of the <code>Processing</code> state is <em>the initial effect of the request can happen</em>. This is best explained by an example: Consider a counter canister. It exports a method <code>inc</code> that increases the counter. Assume that the canister is bug free, and is not going to be forcibly removed. A user submits a request to call <code>inc</code>. If the use sees request status <code>Processing</code>, the state change is guaranteed to happen, and the user can stop monitoring the status and does not have to retry submitting.</p>
</div>
<div class="paragraph">
<p>A message may be rejected by the system or the canister. In either case, there is no guarantee about how much processing of the request has happened.</p>
</div>
<div class="paragraph">
<p>When asking the system about the state or response of a request, the user uses a request id (see <a href="#api-request-id">Request ids</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_synchronous_requests">Synchronous requests</h4>
<div class="paragraph">
<p>Other interactions do not change the state of the system, but only <em>read</em> from it. These may either be untrustworthy, in the sense that a malicious node can make up stuff (e.g. query calls to canisters), or certified, in the sense that the node can prove to the user that this is indeed the system&#8217;s view of things (e.g. reading request statuses, reading account balances). All these reads go through the <code>read</code> RPC endpoint.</p>
</div>
<div class="paragraph">
<p>We use the term <em>request</em> both for the asynchronous requests that passed to <code>submit</code>, as well as for the parameters of a <em>read</em>, so that common operations like signing can be done in the same way.</p>
</div>
</div>
<div class="sect3">
<h4 id="api-endpoints">Request Endpoints</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This document does not yet explain how to find the location and port of a running Internet Computer Node, nor how to find out which node(s) to talk to for a given canister.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following API endpoints are provided:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/api/v1/submit
/api/v1/read</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Should we add features that <em>change the state</em> but are node-specific (e.g., “restart”), then these would go through a new endpoint like <code>/api/v1/command</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For these endpoints, the user performs a POST request over HTTPS with <code>Content-type: application/cbor</code>. The body is an CBOR value containing the request object.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>/api/v1/submit</code> endpoint accepts the <em>asynchronous</em> requests. Upon successful submission, a (code 202) HTTP response without a body is returned; the user can use separate <code>request_status</code> requests (see <a href="#api-request-status">Request status</a>) to determine the response.</p>
</li>
<li>
<p>The <code>/api/v1/read</code> endpoint accepts the <em>synchronous</em> requests. It returns a response (a CBOR value) as the body of the (code 200) HTTP response.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In both cases case, the usual HTTP errors (e.g. 503) may occur.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For some types of synchronous requests (but not all), the node will be able to <em>prove</em> that the overall system agrees on the particular value (e.g. fetching the response from an update call). For which reads, and how this can happen, still needs to be specified.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some or all calls to <code>/api/v1/read</code> might have to be paid for using a micro payment scheme (e.g. state-channel) that is to be specified.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="field-types">Field types</h3>
<div class="paragraph">
<p>The system supports a number of requests, represented as records, i.e. fields with names and values.</p>
</div>
<div class="paragraph">
<p>The fields are typed and can have one of these types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nat</code>: A (possibly unbounded) natural number</p>
</li>
<li>
<p><code>text</code>: Human readable text (e.g. sequence of Unicode codepoints)</p>
</li>
<li>
<p><code>blob</code>: Arbitrary binary data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For readablity, we use the following type synonyms:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type PrincipalId = blob
type CanisterId = PrincipalId
type UserId = PrincipalId</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Of course, user ids and canister ids are <em>not</em> just arbitrary binary blobs, but have structure (e.g. “exactly 64 bits long”, or “size of a hash”). But it is possible that any concrete choice will have to be revised or extended later. In order to not break existing code (especially existing canister), the interface uses arbitrary blobs here.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_common_fields">Common fields</h3>
<div class="paragraph">
<p>The following fields is common among all requests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>request_type</code> (<code>text</code>): Indicates the type of request, and is one of the values specified in <a href="#request-types">Request types</a>.</p>
</li>
<li>
<p>The fields <code>sender_pubkey</code>, <code>sender_sig</code>, <code>expiry</code>, <code>nonce</code>, as specified in <a href="#authentication">Authentication</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="authentication">Authentication</h3>
<div class="paragraph">
<p>All requests coming in via the HTTP interface need to be <em>authenticated</em> using a cryptographic signature. To that end, the following fields are added to these requests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>expiry</code>: time(?) until the request must be executed or dropped <mark>TODO: details</mark>.</p>
</li>
<li>
<p><code>nonce</code> (<code>blob</code>, optional): Arbitrary user-provided data, typically randomly generated. This can be used to create distinct requests with otherwise identical fields.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Furthermore, the requests records are wrapped in a envelope record with these fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sender_pubkey</code> (<code>blob</code>): Public key used to authenticate this request. Since a user may have more than one key, this field tells the system which key is used.</p>
</li>
<li>
<p><code>sender_sig</code> (<code>blob</code>): Signature to authenticate this request.</p>
</li>
<li>
<p><code>content</code> (<code>record</code>): the actual request content</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For requests that have a <code>sender</code> field, the public key must authenticate the <code>sender</code> principal. For the <code>request_status</code> request, the public key must authenticate the sender of the original request.</p>
</div>
<div class="paragraph">
<p>A public key can authenticate a principal id if the latter is a self-authenticating id derived from that public key (see <a href="#id-classes">Special forms of IDs</a>).</p>
</div>
<div class="paragraph">
<p>The envleope fields do <em>not</em> contribute to the calculation of the <code>request_id</code> (see <a href="#api-request-id">Request ids</a>), because the signature is based on the <code>request_id</code>, and because the signatures are not semantically relevant. The <code>expiry</code> and <code>nonce</code> fields do.</p>
</div>
<div class="paragraph">
<p>The signature schemes used to authenticate users are</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://ed25519.cr.yp.to/index.html"><strong>Ed25519</strong></a> or</p>
</li>
<li>
<p><a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf"><strong>ECDSA</strong></a> on curve P-256 (also known as <code>secp256r1</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Request fields that indicate public key (<code>sender_pubkey</code>, <code>public_key</code>) are binary blobs that contain DER encodings of the public keys, see RFCs <a href="https://tools.ietf.org/rfc/rfc3279">3279</a>, <a href="https://tools.ietf.org/rfc/rfc5758">5758</a>, and <a href="https://tools.ietf.org/html/rfc8410">8410</a>.</p>
</li>
<li>
<p>Request fields that indicate signatures (<code>sender_sig</code>) are binary blobs, size 64 bytes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>sender_sig</code> is calculated by signing the 32 byte <a href="#api-request-id"><em>request id</em></a> with the secret key that belongs to the public key specified in <code>public_key</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Information related to gas payments in a user-pays model would also be specified here, as a general mechanism for various request types.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="request-types">Request types</h3>
<div class="paragraph">
<p>The following subsections list all supported requests, including their classification (synchronous vs. asynchronous), their request type, the set of fields of the request record and of the reply object and a description of their pupose.</p>
</div>
<div class="sect3">
<h4 id="api-create-canister">Canister creation</h4>
<div class="paragraph">
<p>Before deploying a canister, the controller of the canister first has to register it with the system, to get a canister id (with an empty canister behind it), and then separately install the code.</p>
</div>
<div class="paragraph">
<p>If the request indicates a desired id, the system checks that it is derived from the caller id and not yet used; otherwise it creates a fresh opaque id.</p>
</div>
<div class="paragraph">
<p>A canister has a list of <em>controllers</em>; initially, the user who has registered the canister is the only controller.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronicity</dt>
<dd>
<p>asynchronous</p>
</dd>
<dt class="hdlist1">Request type</dt>
<dd>
<p><code>create_canister</code></p>
</dd>
<dt class="hdlist1">Request fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sender</code> (<code>PrincipalId</code>): The user who issued the request.</p>
</li>
<li>
<p><code>desired_id</code> (<code>PrincipalId</code>, optional): The id the system should use for the canister</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Reply fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>canister_id</code> (<code>CanisterId</code>): The canister id of the just created canister.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Until code is installed, the canister behaves like one with no public methods.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This request may later contain specifications of particular features needed from the hosting subnet
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="api-install-code">Canister code installation</h4>
<div class="paragraph">
<p>Canister code can be installed for an empty canister (created via <a href="#api-create-canister">Canister creation</a>), or over an existing canister version. In the latter case, the state can be preserved (“canister upgrade”), or it can be wiped (“reinstallation“, e.g. to recover from a broken canister).</p>
</div>
<div class="paragraph">
<p>After an empty canister has been created via <a href="#api-create-canister">Canister creation</a>, the admin can install the first code:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronicity</dt>
<dd>
<p>asynchronous</p>
</dd>
<dt class="hdlist1">Request type</dt>
<dd>
<p><code>install_code</code></p>
</dd>
<dt class="hdlist1">Request fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sender</code> (<code>PrincipalId</code>): The user who issued the request.</p>
</li>
<li>
<p><code>canister_id</code> (<code>CanisterId</code>): The id of the canister to install code for.</p>
</li>
<li>
<p><code>module</code> (<code>blob</code>): A <a href="#canister-module-format">canister module</a></p>
</li>
<li>
<p><code>arg</code> (<code>blob</code>): Initialization arguments</p>
</li>
<li>
<p><code>compute_allocation</code> (<code>nat</code>, optional): The initial allocation requested, in percent.</p>
</li>
<li>
<p><code>mode</code> (string, one of <code>install</code>, <code>replace</code>, <code>upgrade</code>, optional default <code>install</code>): If <code>install</code>, the canister must be empty. If <code>upgrade</code>, indicates that this is an upgrade: the canister must already exist, be non-empty, and the existing version&#8217;s <a href="#system-api-upgrades">pre-upgrade hook</a> must succeed. If <code>replace</code>, then the canister must already exist, but otherwise behaves like a fresh installation.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Reply fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Only a user who is a <em>controller</em> for the canister can install code.</p>
</div>
<div class="paragraph">
<p>If <code>mode = install</code> or <code>mode = replace</code>, this will instantiate the canister module and invoke its <code>canister_init</code> system method (if present), as explained in Section “<a href="#system-api-init">Canister initializaion</a>”, passing the <code>arg</code> to the canister. Upon replacing an existing canister, all state (including the stable memory) is cleared.</p>
</div>
<div class="paragraph">
<p>If <code>mode = upgrade</code>, this will perform an upgrade of an existing canister module as described in <a href="#system-api-upgrades">Canister upgrades</a>.</p>
</div>
<div class="paragraph">
<p>This is atomic: If the response to this request is a <code>reject</code>, then this request had no effect.</p>
</div>
<div class="paragraph">
<p>The optional field <code>compute_allocation</code>, if present, must be a number between 0 and 100, inclusively. It indicates how much computer power should be guaranteed to this canister, expressed as a percentage of the maximum computer power that a single canister can allocate. If absent, it is treated like an allocation of 0.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some canisters may not be able to make sense of callbacks after upgrades; these should be stopped first, to wait for all outstanding callbacks. It is expected that the canister admin does that separately.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This assumes that a canister module fits into a single request. If this assumption turns out to be false, we will provide a more elaborate multi-step interface for code installation. But even then, this simple, atomic way is worth keeping (less error conditions), so we are forward-compatible.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="api-controllers">Canister controller managemnet</h4>
<div class="paragraph">
<p>To allow other users (and eventually canisters) to control the canister, the set of controllers of a canister can be extended.</p>
</div>
<div class="paragraph">
<p>Only a user who currently is a <em>controller</em> for the canister can use these requests.</p>
</div>
<div class="sect4">
<h5 id="_adding_controllers">Adding controllers</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronicity</dt>
<dd>
<p>asynchronous</p>
</dd>
<dt class="hdlist1">Request type</dt>
<dd>
<p><code>set_controller</code></p>
</dd>
<dt class="hdlist1">Request fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sender</code> (<code>PrincipalId</code>): The user who issued the request.</p>
</li>
<li>
<p><code>canister_id</code> (<code>CanisterId</code>): The id of the canister</p>
</li>
<li>
<p><code>controller</code> (<code>PrincipalId</code>): The controller to add to the set of controllers</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Reply fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_removing_controllers">Removing  controllers</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronicity</dt>
<dd>
<p>asynchronous</p>
</dd>
<dt class="hdlist1">Request type</dt>
<dd>
<p><code>remove_controller</code></p>
</dd>
<dt class="hdlist1">Request fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sender</code> (<code>PrincipalId</code>): The user who issued the request.</p>
</li>
<li>
<p><code>canister_id</code> (<code>CanisterId</code>): The id of the canister</p>
</li>
<li>
<p><code>controller</code> (<code>PrincipalId</code>): The controller to remove from the set of controller</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Reply fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The <code>remove_controller</code> request is rejected if the given <code>controller</code> is <em>not</em> in the set of controllers.</p>
</div>
<div class="paragraph">
<p>The set of controllers may become empty.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="api-update">Canister update call</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronicity</dt>
<dd>
<p>asynchronous</p>
</dd>
<dt class="hdlist1">Request type</dt>
<dd>
<p><code>call</code></p>
</dd>
<dt class="hdlist1">Request fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sender</code> (<code>PrincipalId</code>): The user who issued the request.</p>
</li>
<li>
<p><code>canister_id</code> (<code>CanisterId</code>): The id of the canister to call.</p>
</li>
<li>
<p><code>method_name</code> (<code>text</code>): Name of the canister method to call</p>
</li>
<li>
<p><code>arg</code> (<code>blob</code>): Argument to pass to the canister method</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Reply fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>arg</code> (<code>blob</code>): The blob representing the data replied by the canister.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This request type can <em>also</em> be used to call a query method. A user may choose to go this way, instead of via the likely faster and cheaper <a href="#api-query">Canister query call</a> below, if they want to get a <em>certified</em> response.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Other arguments besides data (e.g. payments) will be represented in further fields next to <code>arg</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="api-request-status">Request status</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronicity</dt>
<dd>
<p>synchronous</p>
</dd>
<dt class="hdlist1">Request type</dt>
<dd>
<p><code>request_status</code></p>
</dd>
<dt class="hdlist1">Request fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>request_id</code> (<code>blob</code>): The request id to check the status for, see <a href="#api-request-id">Request ids</a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Response fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>status</code> (<code>text</code>): one of <code>unknown</code>, <code>received</code>, <code>processing</code>, <code>replied</code> or <code>rejected</code>, see <a href="#async-requests">Asynchronous requests</a> for more details on what each status means.</p>
</li>
<li>
<p><code>reply</code>: If the status is <code>replied</code>, then this member contains the request-type specific reply object (see the specification for the individual request types for which fields exist).</p>
</li>
<li>
<p><code>reject_code</code> (<code>nat</code>): If the status is <code>rejected</code>, then this member contains the reject code (see <a href="#reject-codes">Reject codes</a>).</p>
</li>
<li>
<p><code>reject_message</code> (<code>text</code>): If the status is <code>rejected</code>, then this member contains a textual diagnostic message.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Immediately after submitting a request, this may fail (e.g. return with <code>unknown</code>) even though the system is still working on accepting the request as pending.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Request responses will not actually be kept around indefinitely, and eventually the status will revert to <code>unknown</code>. This will happen no sooner than the request’s expiry time, so that replay attacks are prevented, but likely longer, so that users have a chance to fetch it. The precise policy is not yet defined.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="api-query">Canister query call</h4>
<div class="paragraph">
<p>Canister methods that do not change the canister state in a meaningful way can be executed more efficiently. This method provides that ability, and returns the canister’s response directly within the HTTP response.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronicity</dt>
<dd>
<p>synchronous</p>
</dd>
<dt class="hdlist1">Request type</dt>
<dd>
<p><code>query</code></p>
</dd>
<dt class="hdlist1">Request fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sender</code> (<code>PrincipalId</code>): The user who issued the request.</p>
</li>
<li>
<p><code>canister_id</code> (<code>CanisterId</code>): The id of the canister to query.</p>
</li>
<li>
<p><code>method_name</code> (<code>text</code>): Name of the canister query method to call</p>
</li>
<li>
<p><code>arg</code> (<code>blob</code>): Argument to pass to the canister method</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Response fields</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>status</code> (<code>text</code>): One of <code>replied</code> or <code>rejected</code></p>
</li>
<li>
<p><code>reply</code>: If the status is <code>replied</code>, then this member contains the call reply, just as specified in <a href="#api-update">Canister update call</a>.</p>
</li>
<li>
<p><code>reject_code</code> (<code>nat</code>): If the status is <code>rejected</code>, then this member contains the reject code (see <a href="#reject-codes">Reject codes</a>).</p>
</li>
<li>
<p><code>reject_message</code> (<code>text</code>): If the status is <code>rejected</code>, then this member contains a textual diagnostic message.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="api-request-id">Request ids</h3>
<div class="paragraph">
<p>When querying the status of a request (see <a href="#api-request-status">Request status</a>), the user identifies the request using a <em>request id</em>. The request id is a simple “object hash” of the request&#8217;s <code>content</code>, as described here. The hash operation is always SHA-256.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Treat the request type as the value of a text field named <code>request_type</code>.</p>
</li>
<li>
<p>For each field that is present in the request (i.e. omitted optional fields are indeed omitted):</p>
<div class="ulist">
<ul>
<li>
<p>hash the fields name (in ascii-encoding, without terminal <code>\x00</code>) and the value (with the encoding specified below).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sort these by the hash of the field name.</p>
</li>
<li>
<p>Concatenate these hashes, and hash the result.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The resulting hash of 256bits (32 bytes) is the id of the request.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The request id is independent of the representation of the request (JSON, CBOR, something else), and does not change if the specification adds further optional field to a request type.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The recommended textual representation of a request id is a hexadecimal string with capital letters prefixed with '0x'.
E.g., request id consisting of bytes <code>[00, 01, 02, 03, 04, 05, 06, 07, 08, 09, 0A, 0B, 0C, 0D, 0E, 0F, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 1A, 1B, 1C, 1D, 1E, 1F]</code> should be displayed as <code>0x000102030405060708090A0B0C0D0E0F101112131415161718191A1B1C1D1E1F</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following encodings of field values are used</p>
</div>
<div class="ulist">
<ul>
<li>
<p>String fields (<code>request_type</code>, <code>method_name</code>) are encoded in UTF-8, without a terminal <code>\x00</code>.</p>
</li>
<li>
<p>Binary blobs (<code>canister_id</code>, <code>arg</code>, <code>nonce</code>, <code>module</code>) are hashed as they are.</p>
</li>
<li>
<p>Nat fields (<code>compute_allocation</code>) are hashed using <a href="https://en.wikipedia.org/wiki/LEB128#Unsigned_LEB128">Unsigned LEB128</a> encoding.
For example, <code>0</code> should be hashed as a single zero byte <code>[0x00]</code> and <code>624485</code> should be hashed as byte sequence <code>[0xE5, 0x8E, 0x26]</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Example calculation (where <code>H</code> denotes SHA-256 and <code>·</code> denotes blob concatenation):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>request_id_of({ request_type: "call", canister_id: 0x00000000000004D2, method_name: "hello", arg: "DIDL\x00\xFD*"})
 = H(concat (sort
   [ H("request_type") · H("call")
   , H("canister_id") · H("\x00\x00\x00\x00\x00\x00\x04\xD2")
   , H("method_name") · H("hello")
   , H("arg") · H("DIDL\x00\xFD*")
   ]))
 = H(concat (sort
   [ 769e6f87bdda39c859642b74ce9763cdd37cb1cd672733e8c54efaa33ab78af9 · 7edb360f06acaef2cc80dba16cf563f199d347db4443da04da0c8173e3f9e4ed
   , 0a3eb2ba16702a387e6321066dd952db7a31f9b5cc92981e0a92dd56802d3df9 · 4d8c47c3c1c837964011441882d745f7e92d10a40cef0520447c63029eafe396
   , 293536232cf9231c86002f4ee293176a0179c002daa9fc24be9bb51acdd642b6 · 2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824
   , b25f03dedd69be07f356a06fe35c1b0ddc0de77dcd9066c4be0c6bbde14b23ff · 6c0b2ae49718f6995c02ac5700c9c789d7b7862a0d53e6d40a73f1fcd2f70189
   ]))
 = H(concat
   [ 0a3eb2ba16702a387e6321066dd952db7a31f9b5cc92981e0a92dd56802d3df9 · 4d8c47c3c1c837964011441882d745f7e92d10a40cef0520447c63029eafe396
   , 293536232cf9231c86002f4ee293176a0179c002daa9fc24be9bb51acdd642b6 · 2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824
   , 769e6f87bdda39c859642b74ce9763cdd37cb1cd672733e8c54efaa33ab78af9 · 7edb360f06acaef2cc80dba16cf563f199d347db4443da04da0c8173e3f9e4ed
   , b25f03dedd69be07f356a06fe35c1b0ddc0de77dcd9066c4be0c6bbde14b23ff · 6c0b2ae49718f6995c02ac5700c9c789d7b7862a0d53e6d40a73f1fcd2f70189
   ])
 = 8781291c347db32a9d8c10eb62b710fce5a93be676474c42babc74c51858f94b</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="reject-codes">Reject codes</h3>
<div class="paragraph">
<p>An API request or inter-canister call that is pending in the system will eventually result in either a <em>reply</em> (indicating success, and carrying data) or a <em>reject</em> (indicating an error of some sorts). A reject contains a <em>rejection code</em> that classifies the error and a (hopefully) helpful error message string.</p>
</div>
<div class="paragraph">
<p>Rejection codes are member of the following enumeration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SYS_FATAL</code> (1):  Fatal system error, retry unlikely to be useful.</p>
</li>
<li>
<p><code>SYS_TRANSIENT</code> (2): Transient system error, retry might be possible.</p>
</li>
<li>
<p><code>DESTINATION_INVALID</code> (3): Invalid destination (e.g. canister/account does not exist)</p>
</li>
<li>
<p><code>CANISTER_REJECT</code> (4): Explicit reject by the canister.</p>
</li>
<li>
<p><code>CANISTER_ERROR</code> (5): Canister error (e.g., trap, no response)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The symbolic names of this enumeration are used throughout this specification, but on all interfaces (HTTPS API, System API), they are represented as positive numbers as given in the list above.</p>
</div>
<div class="paragraph">
<p>The error message is guaranteed to be a string, i.e. not arbitrary binary data.</p>
</div>
<div class="paragraph">
<p>When canisters explicitly reject a message (see <a href="#system-api-requests">Public methods</a>), they can specify the reject message, but <em>not</em> the reject code; it is always <code>CANISTER_REJECT</code>. In this sense, the reject code is trustworthy: If the system resonds with a <code>SYS_FATAL</code> reject, then it really was the system issuing this reject.</p>
</div>
</div>
<div class="sect2">
<h3 id="api-status">Status endpoint</h3>
<div class="paragraph">
<p>Additionally, the Internet Computer provides an API endpoint to obtain various status fields at</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/api/v1/status</pre>
</div>
</div>
<div class="paragraph">
<p>For this endpoint, the user performs a GET request, and receives a CBOR value with the following fields. The Internet Computer may include additional implementation-specific fields.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ic_api_version</code> (string, mandatory): Identifies the interface version supported, i.e. the version of the present document that the internet computer aims to support. Until this document is versioned and the implemnetation is in sync with a released version, the string <code>unversioned</code> should be used instead.</p>
</li>
<li>
<p><code>impl_source</code> (string, optional): Identifies the implementation of the Internet Computer, by convention with the canonical location of the source code (e.g. <code><a href="https://github.com/dfinity/dfinity" class="bare">https://github.com/dfinity/dfinity</a></code>).</p>
</li>
<li>
<p><code>impl_version</code> (string, optional): If the user is talking to a released version of an Internet Computer implementation, this is the version number. For non-released versions, output of <code>git describe</code> like <code>0.1.13-13-g2414721</code> would also be very suitable.</p>
</li>
<li>
<p><code>impl_revision</code> (string, optional): The precise git revision of the Internet Computer implementation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="#api-cbor">CBOR encoding of requests and responses</a> for details on the precise CBOR encoding of this object.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Future additions may include the version of public spec supported (once the public spec itself is versioned), local time, geographic location, and other useful implementation-specific information such as blockheight. This data is not authenticated yet, but may be signed by the node.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="api-cbor">CBOR encoding of requests and responses</h3>
<div class="paragraph">
<p>Requests and responses are specified here as records with named fields and using suggestive human readable syntax. The actual format in body of the HTTP request or response, however, is <a href="https://en.wikipedia.org/wiki/CBOR">CBOR</a>.</p>
</div>
<div class="paragraph">
<p>Concretely, it consists of a data item with major type 6 (“Semantic tag”) and tag value <code>55799</code> (see <a href="https://tools.ietf.org/html/rfc7049#section-2.4.5">Self-Describe CBOR</a>), followed by an record.</p>
</div>
<div class="paragraph">
<p>Requests consist of an envelope record with keys <code>sender_sig</code> (a blob), <code>sender_pubkey</code> (a blob) and <code>content</code> (a record). The first two are metadata that are used for request authentication, while the last one is the actual content of the request.</p>
</div>
<div class="paragraph">
<p>The following encodings are used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Strings: Major type 3 (“Text string”).</p>
</li>
<li>
<p>Blobs: Major type 2 (“Byte string”).</p>
</li>
<li>
<p>Integer numbers: Major type 0 or 1 (“Unsigned/signed integer”) if small enough to fit that type, else the <a href="https://tools.ietf.org/html/rfc7049#section-2.4.2">Bignum</a> format is used.</p>
</li>
<li>
<p>Records: Major type 5 (“Map of pairs of data items”), followed by the fields, where keys are encoded with major type 3 (“Text string”).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As advised by <a href="https://tools.ietf.org/html/rfc7049#section-3">section “Creating CBOR-Based Protocols”</a> of the CBOR spec, we clarify that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Floating-point numbers may not be used to encode integers.</p>
</li>
<li>
<p>Duplicate keys are prohibited in CBOR maps.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A typical request would be (written in <a href="https://tools.ietf.org/html/rfc7049#section-6">CBOR diagnostic notation</a>, which can be checked and converted on <a href="http://cbor.me/">cbor.me</a>):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>55799({
  "sender_sig": h'DEADBEEF',
  "sender_pubkey": h'b7a3c12dc0c8c748ab07525b701122b88bd78f600c76342d27f25e5f92444cde',
  "content": {
    "request_type": "install_code",
    "canister_id": h'ABCD01',
    "module": h'0061736d01000000',
    "arg": h''
  }
})</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_ordering_guarantees">Ordering guarantees</h3>
<div class="paragraph">
<p>In order to allow for a distributed implementation of the Internet Computer, the order in which the various messages between canisters are delivered and executed is not fully specified.</p>
</div>
<div class="paragraph">
<p>The  guarantee we do give is that function calls between two canisters are executed in order, so that a canister that requires in-order execution need not wait for the response from an earlier message to a canister before sending a later message to that same canister.</p>
</div>
<div class="paragraph">
<p>More precisely:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Method calls between any <em>two</em> canisters are delivered in order, as if they
were communicating over a single simple FIFO queue.</p>
</li>
<li>
<p>If a WebAssembly function, within a single invocation, makes multiple calls
to the same canister, they are queued in the order of invocations to <code>ic0.call_simple</code>.</p>
</li>
<li>
<p>Responses (including replies with <code>ic0.msg_reply</code>, explicit rejects with <code>ic0.msg_reject</code> and system-generated error responses) do <em>not</em> have any ordering guarantee relative to each other or to method calls.</p>
</li>
<li>
<p>There is no particular order guarantee for ingress messages submitted via
the HTTP interface.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_synchronicity_across_nodes">Synchronicity across nodes</h3>
<div class="paragraph">
<p>This documents describes the Internet Computer as having a single global state that can be modified and queried. In reality, it consists of many nodes, which may not be perfectly in sync.</p>
</div>
<div class="paragraph">
<p>As long as you talk to one (honest) node only, the observed behavior is nicely sequential. If you issue an update (i.e. state-mutating) call to a canister (e.g. bump a counter), and node A indicates that the call has been executed, and you then issue a query call to node A, then A&#8217;s response is guaranteed to include the effect of the update call (and you will receive the updated counter value).</p>
</div>
<div class="paragraph">
<p>If you then (quickly) issue a read request to node B, it may be that B responds to your read query based on the old state of the canister (and you might receive the old counter value).</p>
</div>
<div class="paragraph">
<p>A related problem is that some reads are not certified, and nodes may be dishonest in their response. In that case, the user might want to get more assurance by querying multiple nodes and comparing the result, which is easier if the all queries run against the same state.</p>
</div>
<div class="paragraph">
<p>Both problems can be solved if read requests can specify the desired state to query, either at-least-this-state (to solve the first problem) or an exactly-this-future-state (to solve the second). This requires some way of identifying states (abstract state counters, timestamps, block heights).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even without this feature, applications can work around these problems. For the first problem, the query result could be such that the user can tell if the query has been received or not. For the second problem, if replies are monotonic in some sense the user can get assurance in their intersection (e.g. if the query returns a list of events that grows over time, then even if different nodes return different lists, the user can get assurance in those events returned by many nodes).
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="canister-module-format">Canister module format</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A canister module is simply a <a href="https://webassembly.github.io/spec/core/index.html">WebAssembly module</a> in binary format (typically <code>.wasm</code>).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is a scaffolding spec, close to the current implementation. It will need refinement for features like initialization parameters, dynamically linked libraries. We probably want to go for some zip-file-with-metadata approach.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="system-api">Canister interface (System API)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The System API is the interface between the running canister and the Internet Computer. It allows the WebAssembly module of a canister to expose functionality to the users (method entry points) and the system (e.g. initialization), and exposes system functionality to the canister (e.g. calling other canisters). Because WebAssembly is rather low-level, it also explains how to express higher level concepts (e.g. binary blobs).</p>
</div>
<div class="paragraph">
<p>We want to leverage advanced WebAssembly features, such as WebAssembly host references. But as they are not yet supported by all tools involved, this section describes an initial System API that does not rely on host references. To emphasize that this is just a preliminary interface, we group the system methods under the module name <code>ic0</code>, planning to use <code>ic</code> for the real deal.
In section [#host-references], we outline some of the proposed uses of WebAssembly host references.</p>
</div>
<div class="sect2">
<h3 id="system-api-module">WebAssembly module requirements</h3>
<div class="paragraph">
<p>In order for a WebAssembly module to be usable as the code for the canister, it needs to conform to the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If it imports a memory, it must import it from <code>env.memory</code>. In the following, “the Wasm memory” refers to this memory.</p>
</li>
<li>
<p>If it imports a table, it must import it from <code>env.table</code>. In the following, “the Wasm table” refers to this table.</p>
</li>
<li>
<p>It may only import functions listed below, at the type given below.</p>
</li>
<li>
<p>It may have a <code>(start)</code> function.</p>
</li>
<li>
<p>If it exports a function called <code>canister_init</code>, the function must have type <code>() -&gt; ()</code>.</p>
</li>
<li>
<p>If it exports any functions called <code>canister_update &lt;name&gt;</code> or <code>canister_query &lt;name&gt;</code> for some <code>name</code>, the functions must have type <code>() -&gt; ()</code>.</p>
</li>
<li>
<p>It may not export both <code>canister_update &lt;name&gt;</code> and <code>canister_query &lt;name&gt;</code> with the same <code>name</code>.</p>
</li>
<li>
<p>No floating point instructions are used in the module. (This may be allowed in the future.)</p>
</li>
<li>
<p>No floating point local or global variables are used in the module. (This may be allowed in the future.)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_interpretation_of_numbers">Interpretation of numbers</h3>
<div class="paragraph">
<p>WebAssembly number types (<code>i32</code>, <code>i64</code>) do not indicate if the numbers are to be interpreted as signed or unsigned. Unless noted otherwise, whenever the System API interprets them as numbers (e.g. memory pointers, buffer offsets, array sizes), they are to be interpreted as unsigned.</p>
</div>
</div>
<div class="sect2">
<h3 id="_entry_points">Entry points</h3>
<div class="paragraph">
<p>The canister provides entry points which are invoked by the system under various circumstances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The canister may export a function named <code>canister_init</code> and type <code>() -&gt; ()</code>.</p>
</li>
<li>
<p>The canister may export a function named <code>canister_pre_upgrade</code> and type <code>() -&gt; ()</code>.</p>
</li>
<li>
<p>The canister may export a function named <code>canister_post_upgrade</code> and type <code>() -&gt; ()</code>.</p>
</li>
<li>
<p>The canister may export functions named <code>canister_update &lt;name&gt;</code> and type <code>() -&gt; ()</code>.</p>
</li>
<li>
<p>The canister may export functions named <code>canister_query &lt;name&gt;</code> and type <code>() -&gt; ()</code>.</p>
</li>
<li>
<p>The canister table may contain functions of type <code>(env : i32) -&gt; ()</code> which may be used as callbacks in <code>ic0.call_simple</code> traps.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the execution of any of these entry points traps for any reason, then all changes to the WebAssembly state, as well as the effect of any externally visible system call (like <code>ic0.msg_reply</code>, <code>ic0.msg_reject</code>, <code>ic0.call_simple</code>), are discarded. For upgrades, this transactional behaviour applies to the  <code>canister_pre_upgrade</code>/<code>canister_post_upgrade</code> sequence as a whole.</p>
</div>
<div class="sect3">
<h4 id="system-api-init">Canister initializaion</h4>
<div class="paragraph">
<p>If <code>canister_init</code> is present, then this is the first exported WebAssembly function invoked by the system. The argument that was passed along with the canister initialization request (see <a href="#api-install-code">Canister code installation</a>) is available to the canister via <code>ic0.msg_arg_data_size/copy</code>.</p>
</div>
<div class="paragraph">
<p>The system assumes the canister to be fully instantiated if the <code>canister_init</code> method entry point returns.  If the <code>canister_init</code> method entry point traps, then canister installation has failed, and the canister is deleted.</p>
</div>
</div>
<div class="sect3">
<h4 id="system-api-upgrades">Canister upgrades</h4>
<div class="paragraph">
<p>When a canister is upgraded to a new version of the code, the system:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Invokes <code>canister_pre_upgrade</code> (if present) on the old instance, to give the canister a chance to clean up (e.g. move data to <a href="#system-api-stable-memory">stable memory</a>).</p>
</li>
<li>
<p>Instantiates the new module, including the execution of <code>(start)</code>, with a fresh WebAssembly state.</p>
</li>
<li>
<p>Invokes <code>canister_post_upgrade</code> (if present) on the new instance.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The stable memory is preserved throughout the process; any other WebAssembly state is discarded.</p>
</div>
<div class="paragraph">
<p>During these steps, no other entry point of the old or new canister is invoked. The <code>canister_init</code> function of the new canister is <em>not</em> invoked.</p>
</div>
<div class="paragraph">
<p>If <code>canister_pre_upgrade</code> or <code>canister_post_upgrade</code> trap, the upgrade has failed, and the canister is reverted to the old state. Otherwise, the upgrade has succeeded, and the old instance is discarded.</p>
</div>
</div>
<div class="sect3">
<h4 id="system-api-requests">Public methods</h4>
<div class="paragraph">
<p>To define a public method of name <code>name</code>, a WebAssembly module exports a function with name <code>canister_update &lt;name&gt;</code> or <code>canister_query &lt;name&gt;</code> and type <code>() -&gt; ()</code>. We call this the <em>method entry point</em>. The name of the exported function distinguishes update and query methods.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The space in <code>canister_update &lt;name&gt;</code> resp. <code>canister_query &lt;name&gt;</code> is intentional.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The argument of the call (e.g. the content of the <code>arg</code> field in the <a href="#api-update">API request to call a canister method</a>) is copied into the canister on demand using the System functions shown below.</p>
</div>
<div class="paragraph">
<p>Eventually, a method will want to send a response, using <code>ic0.reply</code> or <code>ic0.reject</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_callbacks">Callbacks</h4>
<div class="paragraph">
<p>Callbacks are addressed by their table index (as a proxy for a Wasm <code>funcref</code>).</p>
</div>
<div class="paragraph">
<p>In the reply callback for a further <a href="#system-api-call">method call</a>, the argument refers to the response of that call. In reject callbacks, no argument is available.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_overview_of_imports">Overview of imports</h3>
<div class="paragraph">
<p>The following sections describe various system imports, which we summarize here.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ic0.msg_arg_data_size : () -&gt; i32                                      // I U Q Ry
ic0.msg_arg_data_copy : (dst : i32, offset : i32, size : i32) -&gt; ()    // I U Q Ry
ic0.msg_caller_size : () -&gt; (i32)                                      // I G U Q
ic0.msg_caller_copy : (dst : i32, offset: i32, size : i32) -&gt; ()       // I G U Q
ic0.msg_reject_code : () -&gt; i32                                        // Ry Rt
ic0.msg_reject_msg_size : () -&gt; i32                                    // Rt
ic0.msg_reject_msg_copy : (dst : i32, offset : i32, size : i32) -&gt; ()  // Rt
ic0.msg_reply_data_append : (src : i32, size : i32) -&gt; ()              // U Q Ry Rt
ic0.msg_reply : () -&gt; ()                                               // U Q Ry Rt
ic0.msg_reject : (src : i32, size : i32) -&gt; ()                         // U Q Ry Rt
ic0.canister_self_size : () -&gt; (i32)                                   // *
ic0.canister_self_copy: (dst : i32, offset : i32, size : i32) -&gt; ()    // *
ic0.call_simple                                                        // U Ry Rt
  ( callee_src  : i32,
    callee_size : i32,
    name_src    : i32,
    name_size   : i32,
    reply_fun   : i32,
    reply_env   : i32,
    reject_fun  : i32,
    reject_env  : i32,
    data_src    : i32,
    data_size   : i32
  ) -&gt; ( err_code : i32 )
ic0.stable_size() -&gt; (page_count : i32)                                // *
ic0.stable_grow(new_pages : i32) -&gt; (old_page_count : i32)             // *
ic0.stable_write(offset : i32, src : i32, size : i32) -&gt; ()            // *
ic0.stable_read(dst : i32, offset : i32, size : i32) &gt; ()              // *
ic0.debug_print : (src : i32, size : i32) -&gt; ()                        // * s
ic0.trap : (src : i32, size : i32) -&gt; ()                               // * s</pre>
</div>
</div>
<div class="paragraph">
<p>The comment after each functions lists from where these functions may be invoked:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>I</code>: from <code>canister_init</code> or <code>canister_post_upgrade</code></p>
</li>
<li>
<p><code>G</code>: from <code>canister_pre_upgrade</code></p>
</li>
<li>
<p><code>U</code>: from <code>canister_update …</code></p>
</li>
<li>
<p><code>Q</code>: from <code>canister_query …</code></p>
</li>
<li>
<p><code>Ry</code>: from a reply callback</p>
</li>
<li>
<p><code>Rt</code>: from a reject callback</p>
</li>
<li>
<p><code>s</code>: the <code>(start)</code> module initialization function</p>
</li>
<li>
<p><code>*</code> = <code>I U Q Ry Rt</code> (NB: Not <code>(start)</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the canister invokes a system imports from somewhere else, it will trap.</p>
</div>
</div>
<div class="sect2">
<h3 id="_method_arguments">Method arguments</h3>
<div class="paragraph">
<p>The canister can access an argument. For <code>canister_init</code> and method entrypoints, the argument is the argument of the call; in a reply callback, it refers to the received reply; in a reject callback, no argument is available. In other words, the lifetime of the argument data is a single WebAssembly function execution, not the whole method call tree.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ic0.msg_arg_data_size : () -&gt; i32</code></p>
<div class="paragraph">
<p>Size, in bytes, of the argument data.</p>
</div>
</li>
<li>
<p><code>ic0.msg_arg_data_copy : (dst : i32, offset : i32, size : i32) -&gt; ()</code></p>
<div class="paragraph">
<p>Copies <code>size</code> bytes from <code>msg_arg[offset..offset+size]</code> to <code>memory[dst..dst+size]</code>, i.e., from the argument data into the Wasm memory.</p>
</div>
<div class="paragraph">
<p>This traps if <code>offset+size</code> is greater than the size of the argument data, or if <code>dst+size</code> exceeds the size of the Wasm memory.</p>
</div>
</li>
<li>
<p></p>
<div class="literalblock">
<div class="content">
<pre>ic0.msg_caller_size : () -&gt; (i32)
ic0.msg_caller_copy : (dst : i32, offset: i32, size : i32) -&gt; ()</pre>
</div>
</div>
<div class="paragraph">
<p>The identity of the caller, which may be a canister id or a user id. During canister installation or upgrade, this is the id of of the user or canister requesting the installation or upgrade.</p>
</div>
</li>
<li>
<p><code>ic0.msg_reject_code : () -&gt; i32</code></p>
<div class="paragraph">
<p>Returns the reject code, if the current function is invoked as a reject callback.</p>
</div>
<div class="paragraph">
<p>It returns the special “no error” code <code>0</code> if the callback is <em>not</em> invoked as a reject callback; this allows canisters to use a single entry point for both the reply and reject callback, if they choose to do so.</p>
</div>
</li>
<li>
<p><code>ic0.msg_reject_msg_size : () -&gt; i32</code></p>
<div class="paragraph">
<p>Returns the size of the reject message, in bytes.</p>
</div>
</li>
<li>
<p><code>ic0.msg_reject_msg_copy : (dst : i32, offset : i32, size : i32) -&gt; ()</code></p>
<div class="paragraph">
<p>Copies <code>size</code> bytes from <code>reject_msg[offset..offset+size]</code> to <code>memory[dst..dst+size]</code>.</p>
</div>
<div class="paragraph">
<p>This traps if <code>offset+size</code> is greater than the size of the reject message, or if <code>dst+size</code> exceeds the size of the Wasm memory.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_responding">Responding</h3>
<div class="paragraph">
<p>Eventually, the canister will want to respond to the original call, either by replying (indicating success) or rejecting (signalling an error):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ic0.msg_reply_data_append : (src : i32, size : i32) -&gt; ()</code></p>
<div class="paragraph">
<p>Copies the data referred to by <code>src</code>/<code>size</code> out of the canister and appends it to the (initially empty) data reply.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This can be invoked multiple times to build up the argument with data from various places on the Wasm heap. This way, the canister does not have to first copy all the pieces from various places into one location.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This system call traps if <code>src+size</code> exceeds the size of the WebAssembly memory, or if the current call already has been responded to.</p>
</div>
</li>
<li>
<p><code>ic0.msg_reply : () -&gt; ()</code></p>
<div class="paragraph">
<p>Replies to the sender with the data assembled using <code>ic0.msg_reply_data_append</code>.</p>
</div>
<div class="paragraph">
<p>This function can be called at most once (a second call will trap), and must be called exactly once to indicate success.</p>
</div>
</li>
<li>
<p><code>ic0.msg_reject : (src : i32, size : i32) -&gt; ()</code></p>
<div class="paragraph">
<p>Rejects the call. The data referred to by <code>src</code>/<code>size</code> is used for the diagnostic message.</p>
</div>
<div class="paragraph">
<p>This system call traps if <code>src+size</code> exceeds the size of the WebAssembly memory, or if the current call already has been responded to, or if the data referred to by <code>src</code>/<code>size</code> is not valid UTF8.</p>
</div>
<div class="paragraph">
<p>The other end will receive this reject with reject code <code>CANISTER_REJECT</code>, see <a href="#reject-codes">Reject codes</a>.</p>
</div>
<div class="paragraph">
<p>Possible reply data assembled using <code>ic0.msg_reply_data_append</code> is discarded.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="system-api-canister-self">Self-identification</h3>
<div class="paragraph">
<p>A canister can learn about its own identity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p></p>
<div class="literalblock">
<div class="content">
<pre>ic0.canister_self_size : () -&gt; (i32)
ic0.canister_self_copy: (dst : i32, offset : i32, size : i32) -&gt; ()</pre>
</div>
</div>
<div class="paragraph">
<p>These functions allow the canister to query its own canister id (as a blob). As usual, <code>_size</code> returns the size in bytes and <code>_copy</code> can be used to copy bytes from the blob into the Wasm heap.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="system-api-call">Inter-canister method calls</h3>
<div class="paragraph">
<p>When handling an update call (or a callback), a canister can do further calls to another canister.</p>
</div>
<div class="ulist">
<ul>
<li>
<p></p>
<div class="literalblock">
<div class="content">
<pre>ic0.call_simple : (
  callee_src  : i32,
  callee_size : i32,
  name_src    : i32,
  name_size   : i32,
  reply_fun   : i32,
  reply_env   : i32,
  reject_fun  : i32,
  reject_env  : i32,
  data_src    : i32,
  data_size   : i32
) -&gt; ( err_code : i32 )</pre>
</div>
</div>
<div class="paragraph">
<p>This performs a function call to the canister specified by <code>callee_src/_size</code>, calling the method specified by <code>name_src/_size</code>, sending the data specified by <code>data_src/_size</code>.</p>
</div>
<div class="paragraph">
<p>The system records the current function table entry at the index <code>reply_fun</code>. Upon successful completion of the method call, the noted function is executed, and the response data can be queried using <code>ic0.msg_arg_data_size</code>/<code>ic0.msg_arg_data_copy</code>.</p>
</div>
<div class="paragraph">
<p>The system also records the current function table entry at the index <code>reject_fun</code>. If the method call fails, or the other canister explicitly rejects the call, the noted function is executed.</p>
</div>
<div class="paragraph">
<p>These callback functions need to have type <code>(env : i32) -&gt; ()</code>. If they do not have this type, then <code>ic0.call_simple</code> traps.</p>
</div>
<div class="paragraph">
<p>The system queues the call message to the given destination, but does not actually act on it until the current WebAssembly function returns without trapping.</p>
</div>
<div class="paragraph">
<p>If the system returns <code>0</code> as the <code>err_code</code>, the system was able to enqueue the call. In this case, the call will either be delivered, returned because the destination canister does not exist or returned because of an out of gas condition.</p>
</div>
<div class="paragraph">
<p>If the system returns a non-zero value, the call cannot (and will not be) performed.</p>
</div>
<div class="paragraph">
<p>This system call traps if any of the <code>*_src+*_size</code> exceed the size of the WebAssembly memory.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="system-api-stable-memory">Stable memory</h3>
<div class="paragraph">
<p>Canisters have the ability to store and retrieve data from a secondary memory. The purpose of this <em>stable memory</em> is to provide space to store data beyond upgrades.  The interface mirrors roughly the memory-related instructions of WebAssembly, and tries to be forward compatible with exposing this feature as an additional memory.</p>
</div>
<div class="paragraph">
<p>The stable memory is initially empty.</p>
</div>
<div class="ulist">
<ul>
<li>
<p></p>
<div class="literalblock">
<div class="content">
<pre>ic0.stable_size() -&gt; (page_count : i32)</pre>
</div>
</div>
<div class="paragraph">
<p>returns the current size of the stable memory in WebAssembly pages. (One WebAssembly page is 65Ki bytes.)</p>
</div>
</li>
<li>
<p></p>
<div class="literalblock">
<div class="content">
<pre>ic0.stable_grow(new_pages : i32) -&gt; (old_page_count : i32)</pre>
</div>
</div>
<div class="paragraph">
<p>tries to grow the memory by <code>new_pages</code> many pages containing zeroes.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If successful, returns the <em>previous</em> size of the memory (in pages). Otherwise, returns <code>-1</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p></p>
<div class="literalblock">
<div class="content">
<pre>ic0.stable_write(offset : i32, src : i32, size : i32) -&gt; ()</pre>
</div>
</div>
<div class="paragraph">
<p>copies the data referred to by <code>src</code>/<code>size</code> out of the canister and replaces the corresponding segment starting at <code>offset</code> in the stable memory.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This system call traps if <code>src+size</code> exceeds the size of the WebAssembly memory or <code>offset+size</code> exceeds the size of the stable memory.</p>
</div>
<div class="ulist">
<ul>
<li>
<p></p>
<div class="literalblock">
<div class="content">
<pre>ic0.stable_read(dst : i32, offset : i32, size : i32) &gt; ()</pre>
</div>
</div>
<div class="paragraph">
<p>copies the data referred to by <code>offset</code>/<code>size</code> out of the stable memory and replaces the corresponding bytes starting at <code>dest</code> in the canister memory.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This system call traps if <code>dst+size</code> exceeds the size of the WebAssembly memory or <code>offset+size</code> exceeds the size of the stable memory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_aids">Debugging aids</h3>
<div class="paragraph">
<p>During local development and execution on a local network, the canister needs a way to emit textual trace messages. On the “real” network, these do not do anything.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ic0.debug_print : (src : i32, size : i32) -&gt; ()</code></p>
<div class="paragraph">
<p>When executing in an environment that supports debugging, this copies out the data specified by <code>src</code> and <code>size</code>, and logs, prints or stores it in an environment-appropriate way. The copied data may likely be a valid string in UTF8-encoding, but the environment should be prepared to handle binary data (e.g. by printing it in escaped form).</p>
</div>
<div class="paragraph">
<p>Semantically, this function is always a no-op, and never traps, even if the <code>src+size</code> exceeds the size of the memory, or if this function is executed from <code>(start)</code>. If the environment cannot perform the print, it just skips it.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We may at some point require modules deployed to the real network to not even import this function.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similarly, the system allows the canister to effectively trap, but give some indication about why it trapped:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ic0.trap : (src : i32, size : i32) -&gt; ()</code></p>
<div class="paragraph">
<p>This function always traps.</p>
</div>
<div class="paragraph">
<p>The environment may copy out the data specified by <code>src</code> and <code>size</code>, and log, print or store it in an environment-appropriate way, or include it in system-generated reject messages where appropriate. The copied data may likely be a valid string in UTF8-encoding, but the environment should be prepared to handle binary data (e.g. by printing it in escaped form).</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="host-references">Outlook: Using Host References</h3>
<div class="paragraph">
<p>The Internet Computer aims to make the most of the WebAssembly platform, and embraces WebAssembly features. With WebAssembly host references, we can make the platform more secure, the interfaces more abstract and more compositional. The above <code>ic0</code> System API does not yet use WebAssembly host references. Once they become available on our platform, a new version of the System API using host references will be available via the <code>ic</code> module. The changes will be, at least</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The introduction of a <code>api_nonce</code> reference, which models the capability to use the System API. It is passed as an argument to <code>canister_init</code>, <code>canister_update &lt;name&gt;</code> etc., and expected as an argument by almost all system function calls. (The debugging aids remain unconstrainted.)</p>
</li>
<li>
<p>The use of references, instead of binary blobs, to address principals (users, canisters), e.g. in <code>ic0.msg_caller</code> or in <code>ic0.call_simple</code>. Additional functions will be provided to convert between the transparent binary representation of principal ids and references.</p>
</li>
<li>
<p>In addition to the monolithic <code>ic0.call_simple</code>, a compositional builder interface to create calls is provided.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A canister may only use the old <em>or</em> the new interface; the system detects which interface the canister intends to use based on the names and types of its function imports and exports.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="public-spec">Abstract public behavior</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The sections above describe the interface, i.e. outer edges of the Internet Computer, but give only intuitive and rather vague information about what these interfaces actually do.</p>
</div>
<div class="paragraph">
<p>This section aims to address that question with great precision, by describing the <em>abstract state</em> of the whole Internet Computer, and how this state can change in response to API function calls, or spontaneously (modeling asynchronous, distributed or non-deterministic execution).</p>
</div>
<div class="paragraph">
<p>The design of this abstract specification (e.g. how and where pending messages are stored) are <em>not</em> to be understood to in any way prescribe a concrete implementation or software architecture. The goals here are formal precision and clarity, but not implementability, so this can lead to different ways of phrasing.</p>
</div>
<div class="sect2">
<h3 id="_notation">Notation</h3>
<div class="paragraph">
<p>We specify the behavior of the system using pseudo-code.</p>
</div>
<div class="paragraph">
<p>The manipulated values are primitive values (numbers, text, binary blobs), aggregate values (lists, unordered lists a.k.a. bags, partial maps, records with fixed fields, named constructors) and functions.</p>
</div>
<div class="paragraph">
<p>We use an concatenation operator <code>·</code> with various types: to extend sets and maps, or to concatenate lists with lists or lists with elements.</p>
</div>
<div class="paragraph">
<p>The shape of values is described using a hand-wavy type system.  We use <code>Foo = Nat</code> to define type aliases; now <code>Foo</code> can be used instead of <code>Nat</code>. Often, the right-hand side is a more complex type here, e.g. a record, or multiple possible types separated by a vertical bar (<code>|</code>). Partial maps are written as  <code>Key ↦ Value</code> and the function type as <code>Argument &#8594; Result</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All values are immutable! State change is specified by describing the new state, not by changing existing state.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Record fields are accessed using dot-notation (e.g. <code>S.request_id &gt; 0</code>). To create a new record from an existing record <code>R</code> with some fields changed, the syntax <code>R where field = new_value</code> is used. This syntax can also be used to create new records with some deeply nested field changed: <code>R where some_map[key].field = new_value</code>.</p>
</div>
<div class="paragraph">
<p>In the state transitions, upper-case variables (<code>S</code>, <code>C</code>, <code>Req_id</code>) are free variables: The state transition may be followed for any possible value of these variables. <code>S</code> always refers to the state of the system before. A state transition often comes with a list of <em>conditions</em>, which may restrict the values of these free variables. The <em>state after</em> is usually described using the record update syntax by starting with <code>S where</code>.</p>
</div>
<div class="paragraph">
<p>For example, the condition <code>S.messages = Older_messages · M · Younger_messages</code> says that <code>M</code> is some message in field <code>messages</code> of the record <code>S</code>, and that <code>Younger_messages</code> and <code>Older_messages</code> are the other messages in the system. If the “state after” specifies <code>S with messages = Older_messages · Younger_messages</code>, then the message <code>M</code> is removed from the state.</p>
</div>
</div>
<div class="sect2">
<h3 id="_abstract_state">Abstract state</h3>
<div class="paragraph">
<p>In this specification, we describe the Internet Computer as a state machine. In particular, there is a single piece of data that describes the complete state of the system (called <code>S</code> below).</p>
</div>
<div class="paragraph">
<p>Of course, this is a huge simplification: The real Internet Computer is distributed and has a multi-component architecture, and the state is spread over many different components, some physically separated. But this simplification allows us to have a concise description of the system, and to easily make global decisions (such as, “is there any pending message”), without having to specify the bookkeeping that allows such global decision.</p>
</div>
<div class="sect3">
<h4 id="_identifiers">Identifiers</h4>
<div class="paragraph">
<p>Principal ids (canister ids and user ids) are blobs, but some of them have special form, as explained in <a href="#id-classes">Special forms of IDs</a>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type PrincipalId = Blob</pre>
</div>
</div>
<div class="paragraph">
<p>The predicate</p>
</div>
<div class="literalblock">
<div class="content">
<pre>is_opaque_id : PrincipalId -&gt; Bool</pre>
</div>
</div>
<div class="paragraph">
<p>characterizes all system-assigned blobs.</p>
</div>
<div class="paragraph">
<p>The function</p>
</div>
<div class="literalblock">
<div class="content">
<pre>is_self_authenticating_id : PublicKey -&gt; PrincipalId -&gt; Bool
is_self_authenticating_id pk id = id == H(pk) · 0x02</pre>
</div>
</div>
<div class="paragraph">
<p>characterizes the self-authenting ids.</p>
</div>
<div class="paragraph">
<p>The function</p>
</div>
<div class="literalblock">
<div class="content">
<pre>is_derived_id : PublicKey -&gt; PrincipalId -&gt; Bool
is_derived_id pk id = ∃n. |n| == 8 ∧ id == H(ok) · n · 0x03</pre>
</div>
</div>
<div class="paragraph">
<p>characterizes the derived ids.</p>
</div>
<div class="paragraph">
<p>These three predicates are mutually disjoint.</p>
</div>
<div class="paragraph">
<p>Method names can be arbitrary pieces of text:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>MethodName = Text</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="abstract-canisters">Abstract canisters</h4>
<div class="paragraph">
<p>The <a href="#system-api">WebAssembly System API</a> is relatively low-level, and some of its details (e.g. that the argument data is queried using separate calls, and that closures are represented by a function pointer and a number, that method names need to be mangled) would clutter this section. Therefore, we abstract over the WebAssembly details as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The state of a WebAssembly module (memory, tables, globals) is hidden behind an abstract <code>WasmState</code>. The <code>WasmState</code> contains the <code>StableMemory</code>, which can be extracted using <code>pre_upgrade</code> and passed to <code>post_upgrade</code>.</p>
</li>
<li>
<p>A canister module <code>CanisterModule</code> consists of an initial state, and a (pure) function that models function invocation. It either indicates that the canister function traps, or returns a new state together with a description of the invoked asynchronous System API calls.</p>
<div class="literalblock">
<div class="content">
<pre>WasmState = (abstract)
StableMemory = (abstract)

Arg = {
  data : Blob
  caller: PrincipalId
}

RejectCode = Nat
Response = Reply Blob | Reject (RejectCode, Text)
MethodCall = {
  callee : CanisterId;
  method_name: MethodName;
  arg: Blob;
  callback: Response -&gt; UpdateFunc;
}

UpdateFunc = WasmState -&gt; Trap | Return {
  new_state : WasmState;
  new_calls : List MethodCall;
  response : NoResponse | Response;
}
QueryFunc = WasmState -&gt; Trap | Return Response


CanisterModule = {
  init : (CanisterId, Arg) -&gt; Trap | Return WasmState
  pre_upgrade : (WasmState, caller : PrincipalId) -&gt; Trap | Return StableMemory
  post_upgrade : (CanisterId, StableMemory, Arg) -&gt; Trap | Return WasmState
  update_methods : MethodName ↦ (Arg -&gt; UpdateFunc)
  query_methods : MethodName ↦ (Arg -&gt; QueryFunc)
}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This high-level interface presents a pure, mathematical model of a canister, and hides the bookkeeping required to provide the System API as seen in Section <a href="#system-api">Canister interface (System API)</a>.</p>
</div>
<div class="paragraph">
<p>The <code>CanisterId</code> parameter of <code>init</code> and <code>post_upgrade</code> is merely passed through to the canister, via the <code>canister.self</code> system call.</p>
</div>
<div class="paragraph">
<p>The concrete mapping of this abstract <code>CanisterModule</code> to actual WebAssembly concepts and the System API is described separately in section <a href="#concrete-canisters">Abstract Canisters to System API</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_contexts">Call contexts</h4>
<div class="paragraph">
<p>The Internet Computer provides certain messaging guarantees: If a user or a canister calls another canister, it will eventually get a single response (a reply or a rejection), even if some canister code along the way fails.</p>
</div>
<div class="paragraph">
<p>To ensure that only one response is generated, and also to detect when no response can be generated any more, we maintain a <em>call context</em>. The <code>responded</code> field is set to <code>true</code> once the call has received a response, further attempts to send a response fail.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>CallCtxt = {
  canister : CanisterId;
  origin : CallOrigin;
  responded : bool;
}
CallId = (abstract)
CallOrigin
  = FromUser {
      request : Request;
    }
  | FromCanister {
      calling_context : CallId;
      callback: Response -&gt; WasmFunc
    }</pre>
</div>
</div>
<div class="paragraph">
<p>In this abstract description, call contexts are never garbage collected, even if nothing references them any more; an implementation can do that.</p>
</div>
</div>
<div class="sect3">
<h4 id="_calls_and_messages">Calls and Messages</h4>
<div class="paragraph">
<p>Calls into and within the Internet Computer are implemented as messages passed between canisters. During their lifetime, messages change shape: they begin as a call to a public method, which is resolved to a WebAssembly function that is then executed, potentially generating a response which is then delivered.</p>
</div>
<div class="paragraph">
<p>Therefore, a message can have different shapes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Queue = Unordered | Queue { from : CanisterId; to : CanisterId }
Message
  = CallMessage {
      origin : CallOrigin;
      caller : PrincipalId;
      callee : CanisterId;
      method_name : Text;
      data : Blob;
      queue : Queue;
    }
  | FuncMessage {
      call_context : CallId;
      receiver : CanisterId;
      func : UpdateFunc;
      queue : Queue;
    }
  | ResponseMessage {
      call_context : CallId;
      response : Response;
    }</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>queue</code> field is used to describe the message ordering behavior. Its concrete value is only used to determine when the relative order of two messages must be preserved, and not otherwise interpreted. Response messages are not ordered, as explained above, so they have no <code>queue</code> field.</p>
</div>
<div class="paragraph">
<p>Although the <code>func</code> field of <code>FuncMessage</code> has type <code>UpdateFunc</code>, it could also be a query call. We will see below that an <code>QueryFunc</code> can be modeled as an <code>UpdateFunc</code>.</p>
</div>
<div class="paragraph">
<p>A reference implementation would likely maintain a separate list of <code>messages</code> for each such queue to efficiently find eligible messages; this document chooses this approach for a simpler and more concise system state.</p>
</div>
</div>
<div class="sect3">
<h4 id="_api_requests">API requests</h4>
<div class="paragraph">
<p>We distinguish between the <em>asynchronous</em> API requests passed to <code>/api/v1/submit</code>, which may be present in the system state, and the <em>synchronous</em> API requests passed to <code>/api/v1/read</code>, which are only ephemeral.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Request
  = CreateCanister = {
    nonce : Blob;
    sender : UserId;
    sender_pubkey : PublicKey;
    sender_sig : Signature;
  }
  | InstallCode = {
    nonce : Blob;
    sender : UserId;
    sender_pubkey : PublicKey;
    sender_sig : Signature;
    canister_id :  CanisterId;
    module : CanisterModule;
    mode : Install | Replace | Upgrade;
    data : Blob;
  }
  | AddController = {
    nonce : Blob;
    sender : UserId;
    canister_id :  CanisterId;
    controller :  CanisterId;
  }
  | RemoveController = {
    nonce : Blob;
    sender : UserId;
    canister_id :  CanisterId;
    controller :  CanisterId;
  }
  | CanisterUpdateCall = {
    nonce : Blob;
    sender : UserId;
    sender_pubkey : PublicKey;
    sender_sig : Signature;
    callee : CanisterId;
    method_name : Text;
    data : Blob;
  }</pre>
</div>
</div>
<div class="paragraph">
<p>The evolution of an <code>Request</code> goes through these states, as explained in <a href="#async-requests">Asynchronous requests</a>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>RequestStatus
  = Received
  | Processing
  | Rejected (RejectCode, Text)
  | Completed { result : Value }</pre>
</div>
</div>
<div class="paragraph">
<p>These are the synchronous read messages:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>APIReadRequest
  = ReadStatus = {
    nonce : Blob;
    sender_pubkey : PublicKey;
    sender_sig : Signature;
    request_id : Request;
  }
  | CanisterQuery = {
    nonce : Blob;
    sender : UserId;
    sender_pubkey : PublicKey;
    sender_sig : Signature;
    callee : CanisterId;
    method_name : Text;
    data : Blob;
  }</pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ReadStatus</code> refers to a request by way of a <em>request id</em>, which is a hash of the request content:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Request = Blob
request_id_of : Request -&gt; Request</pre>
</div>
</div>
<div class="paragraph">
<p>The precise algorithm to calculate this request id is specified in <a href="#api-request-id">Request ids</a>.</p>
</div>
<div class="paragraph">
<p>For the signatures in a <code>Request</code>, we assume that the following function implements verification of <a href="https://ed25519.cr.yp.to/index.html"><strong>Ed25519</strong></a> and <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf"><strong>ECDSA</strong></a> signatures, depending on the type of public key.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>PublicKey = Blob
Signature = Blob
verify_signature : PublicKey -&gt; Signature -&gt; Blob -&gt; Bool</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_system_state">The system state</h4>
<div class="paragraph">
<p>Finally, we can describe the state of the Internet Computer as a record having the following fields:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>S = {
  requests : Request ↦ RequestStatus ;
  canisters : CanisterId ↦ CanState;
  controllers : CanisterId ↦ Set UserId;
  call_contexts : CallId ↦ CallCtxt;
  messages : List Message; // ordered!
}
CanState = EmptyCanister | {
  wasm_state : WasmState;
  module : CanisterModule;
}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_initial_state">Initial state</h4>
<div class="paragraph">
<p>The initial state of the system is</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
  requests = ();
  canisters = ();
  controllers = ();
  call_contexts = ();
  messages = ();
}</pre>
</div>
</div>
<div class="paragraph">
<p>using <code>()</code> to denote the empty map or bag.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_state_transitions">State transitions</h3>
<div class="paragraph">
<p>Based on this abstract notion of the state, we can describe the behavior of the system. There are three classes of behaviors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Asynchronous API requests that are submitted via <code>/api/v1/read</code>. These transitions describes checks that the request must pass to be considered received.</p>
</li>
<li>
<p>Spontaneous transitions that model the internal behavior of the system, by describing conditions on the state that allow the transition to happen, and the state after.</p>
</li>
<li>
<p>Responses to reads (i.e. <code>/api/v1/read</code>). By definition, these do <em>not</em> change the state of the system, and merely describe the response based on the read request and the current system state.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The state transitions are not complete with regard to error handling. For example, the behavior of sending a request to a non-existent canister is not specified here. For now, we trust our team to make sensible decisions there.</p>
</div>
<div class="sect3">
<h4 id="_api_request_submission">API Request submission</h4>
<div class="paragraph">
<p>After a node accepts a request via <code>/api/v1/submit</code>, it gets added to the system in the <code>Received</code> state.</p>
</div>
<div class="paragraph">
<p>This may only happen if the following validation steps pass:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The signature on the request is valid.</p>
</li>
<li>
<p>The key used to sign the request matches the public key encoded in the
user&#8217;s self-authenticating id.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More validation (e.g. authorization) steps may be added here.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Submitted request</dt>
<dd>
<p><code>R</code></p>
</dd>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    is_self_authenticating_id R.sender_pubkey R.sender
    verify_signature R.sender_pubkey R.sender_sig (request_id_of(R)) = true</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[R] = Received</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is not instantaneous (the system takes some time to agree it accepts the request) nor guaranteed (a node could just drop the request, or maybe it did not pass validation). But once it has entered the system like this, it will be acted upon.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Due to this check, the <code>sender</code> field of any request in the system state is authenticated, so an implementation may actually drop the <code>sender_sig</code> field at this point.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_request_rejection">Request rejection</h4>
<div class="paragraph">
<p>The system may reject an received message for internal reasons (high load, low resources). The precise conditions are not specified here, but the reject code must indicate this to be a system error.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.requests[R] = Received
    Code = SYS_FATAL or Code = SYS_TRANSIENT</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[R] = Rejected (Code, Msg)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_canister_creation">Canister creation</h4>
<div class="paragraph">
<p>If the request indicates a desired id, the system checks that it is derived from the caller id and not yet used; otherwise it creates a fresh opaque id.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.requests[CreateCanister M] = Received
    match M.desired_id with
	CanisterId -&gt; is_derived_id M.sender CanisterId
	None -&gt; is_opaque_id CanisterId = true
    CanisterId ∉ dom S.canisters</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[CreateCanister M] = Completed { result = { canister_id = CanisterId } }
    canisters[CanisterId] = EmptyCanister
    controllers[CanisterId] = { M.sender }</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_canister_code_installation">Canister code installation</h4>
<div class="paragraph">
<p>Only a controller of the given canister can install code. This transition installs new code over an empty or existing canister. This involves invoking the <code>canister_init</code> system method (see <a href="#system-api-init">Canister initializaion</a>), which must succeed and must not invoke other methods.</p>
</div>
<div class="paragraph">
<p>The <code>compute_allocation</code> is ignored in this abstract model of the Internet Computer, as it does not address questions of performance or scheduling.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.requests[InstallCode M] = Received
       (M.mode = Install &amp;&amp; S.canisters[M.canister_id] = EmptyCanister)
    or (M.mode = Replace &amp;&amp; S.canisters[M.canister_id] ≠ EmptyCanister)
    M.sender ∈ S.controllers[M.canister_id]
    Arg = {
      data = M.data;
      caller = M.caller
    }
    M.module.init(M.canister_id, Arg) = Return New_state</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[InstallCode M] = Completed { result = { } }
    canisters[M.canister_id] = { wasm_state = New_state; module = M.module }</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_canister_code_upgrade">Canister code upgrade</h4>
<div class="paragraph">
<p>Only a controller of the given canister can install new code. This changes the code of an <em>existing</em> canister, preserving the state in the stable memory. This involves invoking the <code>canister_pre_upgrade</code> system method on the old and <code>canister_post_upgrade</code> system method on the new canister, which must succeed and must not invoke other methods.</p>
</div>
<div class="paragraph">
<p>The <code>compute_allocation</code> is ignored in this abstract model of the Internet Computer, as the model does not address questions of performance or scheduling.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.requests[InstallCode M] = Received
    S.canisters[M.canister_id] = { wasm_state = Old_state; module = Old_module }
    M.mode = Upgrade
    M.sender ∈ S.controllers[M.canister_id]
    Arg = {
      data = M.data;
      caller = M.caller
    }
    Old_module.pre_upgrade(Old_State, M.caller) = Return Stable_memory
    M.module.post_upgrade(M.canister_id, Stable_memory, Arg) = Return New_state</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[InstallCode M] = Completed { result = { } }
    canisters[M.canister_id] = { wasm_state = New_state; module = M.module }</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_canister_controller_management">Canister controller management</h4>
<div class="paragraph">
<p>Only a controller of the given canister can modify the controller list.</p>
</div>
<div class="sect4">
<h5 id="_adding_controllers_2">Adding controllers</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.requests[AddController M] = Received
    M.sender ∈ S.controllers[M.canister_id]</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[InstallCode M] = Completed { result = { } }
    controllers[M.canister_id] = controllers[M.canister_id] ∪ { M.controller }</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_removing_controllers_2">Removing controllers</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.requests[RemoveController M] = Received
    M.sender ∈ S.controllers[M.canister_id]
    M.controller ∈ S.controllers[M.canister_id]</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[InstallCode M] = Completed { result = { } }
    controllers[M.canister_id] = controllers[M.canister_id] \ { M.controller }</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_initiating_canister_calls">Initiating canister calls</h4>
<div class="paragraph">
<p>A first step in processing a canister update call is to create a <code>CallMessage</code> in the message queue.</p>
</div>
<div class="paragraph">
<p>The <code>request</code> field of the <code>FromUser</code> origin establishes the connection to the api message. One could use the corresponding <code>request_id_of</code> for this purpose, but this formulation is more abstract.</p>
</div>
<div class="paragraph">
<p>We do not make any guarantees about the order of incoming messages.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.requests[CanisterUpdateCall M] = Received</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[CanisterUpdateCall M] = Processing
    messages =
      CallMessage {
        origin = FromUser { request = CanisterUpdateCall M };
        caller = M.sender;
        callee = M.callee;
        method_name = M.method_name;
        arg = M.arg;
        queue = Unordered;
      } · S.messages</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_call_context_creation">Call context creation</h4>
<div class="paragraph">
<p>Before invoking a message to a public entry point, some bookkeeping is required: A call context is created, and the method is looked up in the list of exports. This happens for both ingress and inter-canister messages.</p>
</div>
<div class="paragraph">
<p>The position of the message in the queue is unchanged.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.messages = Older_messages · CallMessage CM · Younger_messages
    S.canisters[CM.callee] ≠ EmptyCanister
    M = S.canisters[CM.callee].module
    F = if M.method_name ∈ M.update_methods
        then M.update_methods[CM.method_name]
        else query_to_update_func (M.query_methods[CM.method_name])
    Ctxt_id ∉ dom S.call_contexts
    Arg = {
      data = CM.data;
      caller = CM.caller
    }</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    messages =
      Older_messages ·
      FuncMessage {
        call_context = Ctxt_id;
        receiver = CM.callee;
        func = F (Arg);
        queue = CM.queue;
      } ·
      Younger_messages
    call_contexts[Ctxt_id] = {
      canister = CM.callee;
      caller = CM.caller;
      responded = false;
    }</pre>
</div>
</div>
<div class="paragraph">
<p>The function <code>query_to_update_func</code> simply turns a query function into an update function, this is merely a notational trick to simplify the message execution rules:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query_to_update_func f =
  λ arg → λ wasm_state →
    match f(arg)(wasm_state) with
      Trap → Trap
      Return res → Return {
        new_state = wasm_state;
        new_calls = [];
        response = res;
      }</pre>
</div>
</div>
<div class="paragraph">
<p>Note that by construction, a query function will either trap or return with a response; it will never send calls, and it will never change the state of the canister.</p>
</div>
</div>
<div class="sect3">
<h4 id="_message_execution_non_trapping">Message execution (non-trapping)</h4>
<div class="paragraph">
<p>We can execute any message that is at the head of its queue, i.e. there is no
older message with the same abstract <code>queue</code> field.
The actual message execution, if successful, may enqueue further messages and&#8201;&#8212;&#8201;if the function returns a response&#8201;&#8212;&#8201;record this response.
The new call and response messages are enqueued at the end.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.messages = Older_messages · FuncMessage M · Younger_messages
    (M.queue = Unordered) or (∀ msg ∈ Older_messages. msg.queue ≠ M.queue)
    S.canisters[C.callee] ≠ EmptyCanister
    M.func(S.canisters[M.receiver].wasm_state) = Return res
    (res.response = NoResponse) or (S.call_contexts[M.call_context].responded = false)</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    canisters[M.receiver].wasm_state = res.new_state;
    messages =
      Older_messages ·
      Younger_messages ·
      [ CallMessage {
          origin = FromCanister {
            call_context = M.call_context;
            callback = call.callback
          };
          caller = C.callee;
          callee = call.callee;
          method_name = call.method_name;
          arg = call.arg;
          queue = Queue { from = M.receiver; to = call.callee };
        }
      | for call ∈ res.new_calls ] ·
      [ ResponseMessage {
          call_context = M.call_context;
          response = res.response;
        }
      | if res.response ≠ NoResponse ]

     // only if res.response ≠ NoResponse:
     call_contexts[M.call_context].responded = true</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_message_execution_trapping">Message execution (trapping)</h4>
<div class="paragraph">
<p>If a message traps, it gets dropped. No response is generated (some other message may still fulfill this calling context).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.messages = Older_messages · FuncMessage M · Younger_messages
    (M.queue = Unordered) or (∀ msg ∈ Older_messages. msg.queue ≠ M.queue)
    S.canisters[M.callee] ≠ EmptyCanister
    M.func(S.canisters[M.receiver].wasm_state) = Trap</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with messages = Older_messages · Younger_messages</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_message_execution_double_response">Message execution (double response)</h4>
<div class="paragraph">
<p>If a message tries to respond when its calling context has already be responded to, then we treat it like a trapping message.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.messages = Older_messages · FuncMessage M · Younger_messages
    (M.queue = Unordered) or (∀ msg ∈ Older_messages. msg.queue ≠ M.queue)
    S.canisters[M.callee] ≠ EmptyCanister
    M.func(S.canisters[M.receiver].wasm_state) = Return res
    S.call_contexts[M.call_context].responded = true
    res ≠ NoResponse</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with messages = Older_messages · Younger_messages</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_call_context_starvation">Call context starvation</h4>
<div class="paragraph">
<p>If there is no call, downstream calling context or response that could possibly fulfill a calling context, then a reject is synthesized. The error message below is <em>not</em> indicative. In particular, if the system has an idea about <em>why</em> this starved, it can put that in there (e.g. the initial message handler trapped with an out-of-memory access).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.call_contexts[Ctxt_id].responded = false
    ∀ CallMessage msg ∈ S.messages. msg.call_context ≠ Ctxt_id
    ∀ ctxt_ids.
        (S.call_contexts[ctxt_ids].responded = false || S.response[ctxt_ids] exists)
        ==&gt; S.call_contexts[ctxt_ids].caller.calling_context ≠ Ctxt_id</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    call_contexts[Ctxt_id].responded = true
    messages =
      S.messages ·
      ResponseMessage {
        call_context = Ctxt_id;
        response = Reject (CANISTER_ERROR, "starvation");
      }</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_callback_invocation">Callback invocation</h4>
<div class="paragraph">
<p>When an inter-canister call has been responded to, we can queue the call to the callback.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.messages = Older_messages · ResponseMessage RM · Younger_messages
    S.call_contexts[RM.call_context].origin =
      FromCanister {
        call_context = Ctxt_id2
        callback = F
      }</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    messages =
      Older_messages ·
      FuncMessage {
        call_context = Ctxt_id2
        receiver = S.call_contexts[RM.call_context].canister
        func = F (RM.response)
        queue = Unordered
      } ·
      Younger_messages</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_respond_to_user_request">Respond to user request</h4>
<div class="paragraph">
<p>When an ingress method call has been responded to, we can record the response in the list of queries.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    S.requests[M] = Processing
    S.messages = Older_messages · ResponseMessage RM · Younger_messages
    S.call_contexts[RM.call_context].origin = FromUser { request = M }</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    messages = Older_messages · Younger_messages
    requests[M] =
      | Completed { result = R } if response = Reply R
      | Rejected R               if response = Reject R</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_request_clean_up">Request clean up</h4>
<div class="paragraph">
<p>At some point, a request will be removed from memory of the system. This must happen no earlier than the expiry time set in the request, and late enough so that the user had a fair chance of retrieving the response. Details are yet to be determined.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>    (S.requests[M] = Completed _) or (S.requests[M] = Rejected _)</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State after</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>S with
    requests[M] = (deleted)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_read_status">Read: Status</h4>
<div class="paragraph">
<p>The user can query the status of a request. The type of <code>result</code>, given as <code>Value</code> in the above spec, can vary depending on the request type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is a phase where a request was issued by the user, but not received yet by the whole system. During this phase, the request status behaves as if the request has never been seen. It may silently be dropped, or eventually be marked as pending, as seen in the following rules.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Submitted request</dt>
<dd>
<p><code>R</code></p>
</dd>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>   R = ReadStatus RS
   request_id_of(M) = RS.request_id_of
   S.requests[M] = MS
   is_self_authenticating_id RS.sender_pubkey M.sender
   verify_signature RS.sender_pubkey RS.sender_sig (request_id_of(R)) = true</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Read response</dt>
<dd>
<p>A record with</p>
<div class="ulist">
<ul>
<li>
<p><code>{status: accpeted}</code> if <code>MS = Received</code></p>
</li>
<li>
<p><code>{status: processing}</code> if <code>MS = Processing</code></p>
</li>
<li>
<p><code>{status: rejected; reject_code: &lt;code&gt;: reject_message: &lt;msg&gt;}</code> if <code>MS = Rejected (code, msg)</code></p>
</li>
<li>
<p><code>{status: completed; result : &lt;result&gt;}</code> if <code>MS = Completed { result = result }</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_read_query_call">Read: query call</h4>
<div class="paragraph">
<p>Canister query calls can be executed directly.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Submitted request</dt>
<dd>
<p><code>R</code></p>
</dd>
<dt class="hdlist1">Conditions</dt>
</dl>
</div>
<div class="literalblock">
<div class="content">
<pre>  R = CanisterQuery Q
  is_self_authenticating_id Q.sender_pubkey Q.sender
  verify_signature Q.sender_pubkey Q.sender_sig (request_id_of(R)) = true
  S.canisters[Q.callee] ≠ EmptyCanister
  C = S.canisters[Q.callee]
  F = C.module.query_methods[Q.method_name]
  Arg = { data = Q.arg; caller = Q.sender }</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Read response</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>If <code>F(Arg) = Trap</code> then</p>
<div class="literalblock">
<div class="content">
<pre>{status: failed; error: "Query execution trapped"}</pre>
</div>
</div>
</li>
<li>
<p>Else if <code>F(Arg) = Return (Reject (code, msg))</code> then</p>
<div class="literalblock">
<div class="content">
<pre>{status: rejected; reject_code: &lt;code&gt;: reject_message: &lt;msg&gt;}</pre>
</div>
</div>
</li>
<li>
<p>Else if <code>F(Arg) = Return (Reply R)</code> then</p>
<div class="literalblock">
<div class="content">
<pre>{status: success; result: &lt;R&gt; }</pre>
</div>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="concrete-canisters">Abstract Canisters to System API</h3>
<div class="paragraph">
<p>In Section <a href="#abstract-canisters">Abstract canisters</a> we introduced an abstraction over the interface to a canister, to avoid cluttering the abstract specification of the Internet Computer from WebAssembly details. In this section, we will fill the gap and explain how the abstract canister interface maps to the <a href="#system-api">concrete System API</a> and the WebAssembly concepts as defined in the <a href="https://webassembly.github.io/spec/core/index.html">WebAssembly specification</a>.</p>
</div>
<div class="sect3">
<h4 id="_the_concrete_wasmstate">The concrete <code>WasmState</code></h4>
<div class="paragraph">
<p>The abstract <code>WasmState</code> above models the WebAssembly <em>store</em> <code>S</code>, which encompasses the functions, tables, memories and globals of the WebAssembly program, plus additional data maintained by the system, such as the stable memory:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>WasmState = {
  store : S; // a store as per WebAssembly spec
  self_id : CanId;
  stable_mem : Blob
}</pre>
</div>
</div>
<div class="paragraph">
<p>As explained in Section “<a href="#system-api-module">WebAssembly module requirements</a>”, the WebAssembly module imports at most <em>one</em> memory and at most <em>one</em> table; in the following, <em>the</em> memory (resp. table) and the fields <code>mem</code> and <code>table</code> of <code>S</code> refer to that. Any system call that accesses the memory (resp. table) will trap if the module does not import the memory (resp. table).</p>
</div>
<div class="paragraph">
<p>We model <code>mem</code> as an array of bytes, and <code>table</code> as an array of execution functions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_execution_state">The execution state</h4>
<div class="paragraph">
<p>We can model the execution of WebAssembly functions as stateful functions that have access to the WebAssembly store. In order to also model the behavior of the system imports, which have access to additional data structures, we extend the state as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Params = {
  data : NoData | Blob;
  caller : NoCaller | PrincipalId;
  reject_code : 0 | SYS_FATAL | SYS_TRANSIENT | …;
  reject_message : Text;
}
ExecutionState = {
  wasm_state : WasmState;
  params : Params;
  response : NoResponse | Response;
  reply_params : { arg : Blob };
  calls : List Call;
}</pre>
</div>
</div>
<div class="paragraph">
<p>This allows us to model WebAssembly functions, including host-provided imports, as functions with implicit mutable access to an <code>ExecutionState</code>, dubbed <em>execution functions</em>.
Syntactically, we express this using an implicit argument of type <code>ref ExecutionState</code> in angle brackets (e.g. <code>func&lt;es&gt;(x)</code> for the invocation of a WebAssembly function with type <code>(x : i32) -&gt; ()</code>).  The lifetime of the <code>ExecutionState</code> data structure is that one invocation of such a function.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is nonsensical to pass to an execution function a WebAssembly store <code>S</code> that comes from a different WebAssembly module than one defining the function. The current specification does not do that, because every canister gets instantiated exactly once. Once we add upgrading to this document this needs to be checked.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_concrete_canistermodule">The concrete <code>CanisterModule</code></h4>
<div class="paragraph">
<p>Finally we can specify the abstract <code>CanisterModule</code> that models a concrete WebAssembly module.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>initial_wasm_store</code> mentioned below is the store of the WebAssembly module after <em>instantiation</em> (as per WebAssembly spec) of the WasmModule contained in the <a href="#canister-module-format">canister module</a>, including executing a potential <code>(start)</code> function.</p>
</li>
<li>
<p>For more convenience when creating a new <code>ExecutionState</code>, we define the following partial record:</p>
<div class="literalblock">
<div class="content">
<pre>empty_execution_state = {
  wasm_state = (undefined);
  params = (undefined);
  response = NoResponse;
  reply_params : { arg = "" };
  calls : [];
}</pre>
</div>
</div>
</li>
<li>
<p>The <code>init</code> field of the <code>CanisterModule</code> is defined as follows:</p>
<div class="paragraph">
<p>If the WebAssembly module does not export a function called under the name <code>canister_init</code>, then the argument blob is ignored and the <code>initial_wasm_store</code> is returned:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>init = λ (self_id, arg) →
  Return { store = initial_wasm_store; self_id = self_id; stable_mem = "" }</pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise, if the WebAssembly module exports a function <code>func</code> under the name <code>canister_init</code>, it is</p>
</div>
<div class="literalblock">
<div class="content">
<pre>init = λ (self_id, arg) →
  let es = ref {empty_execution_state with
      wasm_state = { store = initial_wasm_store; self_id = self_id; stable_mem = "" }
      params = { data = arg.data; caller = arg.caller; reject_code = 0; reject_message ""}
    }
  try func&lt;es&gt;() with Trap then Trap
  if es.performed_calls ≠ [] then Trap
  if es.response ≠ NoResponse then Trap
  Return es.wasm_state</pre>
</div>
</div>
<div class="paragraph">
<p>This formulation checks afterwards that the system calls <code>call.perform</code> or <code>msg.reply</code> were not invoked; an implementation can of course trap already when these system calls are invoked.</p>
</div>
</li>
<li>
<p>The <code>pre_upgrade</code> field of the <code>CanisterModule</code> is defined as follows:</p>
<div class="paragraph">
<p>If the WebAssembly module does not export a function called under the name <code>canister_pre_upgrade</code>, then it simply returns the stable memory:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>pre_upgrade = λ (old_state, caller) → Return old_state.stable_mem</pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise, if the WebAssembly module exports a function <code>func</code> under the name <code>canister_pre_upgrade</code>, it is</p>
</div>
<div class="literalblock">
<div class="content">
<pre>pre_upgrade = λ (old_state, caller) →
  let es = ref {empty_execution_state with
      wasm_state = old_state
      params = { data = NoData; caller = caller; reject_code = 0; reject_message ""}
    }
  try func&lt;es&gt;() with Trap then Trap
  if es.performed_calls ≠ [] then Trap
  if es.response ≠ NoResponse then Trap
  Return es.wasm_state.stable_mem</pre>
</div>
</div>
</li>
<li>
<p>The <code>post_upgrade</code> field of the <code>CanisterModule</code> is defined as follows:</p>
<div class="paragraph">
<p>If the WebAssembly module does not export a function called under the name <code>canister_post_upgrade</code>, then the argument blob is ignored and the <code>initial_wasm_store</code> is returned:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>post_upgrade = λ (self_id, stable_mem, arg) →
  Return { store = initial_wasm_store; self_id = self_id; stable_mem = stable_mem }</pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise, if the WebAssembly module exports a function <code>func</code> under the name <code>canister_post_upgrade</code>, it is</p>
</div>
<div class="literalblock">
<div class="content">
<pre>post_upgrade = λ (self_id, stable_mem, arg) →
  let es = ref {empty_execution_state with
      wasm_state = { store = initial_wasm_store; self_id = self_id; stable_mem = stable_mem }
      params = { data = arg.data; caller = arg.caller; reject_code = 0; reject_message ""}
    }
  try func&lt;es&gt;() with Trap then Trap
  if es.performed_calls ≠ [] then Trap
  if es.response ≠ NoResponse then Trap
  Return es.wasm_state</pre>
</div>
</div>
</li>
<li>
<p>The partial map <code>update_methods</code> of the <code>CanisterModule</code> is defined for all method names <code>method</code> for which the WebAssembly program exports a function <code>f</code> named <code>canister_update &lt;method&gt;</code>, and has value</p>
<div class="literalblock">
<div class="content">
<pre>update_methods[method] = λ arg → λ wasm_state →
  let es = ref {empty_execution_state with
      wasm_state = wasm_state;
      params = { data = arg.data; caller = arg.caller; reject_code = 0; reject_message = "" }
    }
  try func&lt;es&gt;() with Trap then Trap
  Return {
    new_state = es.wasm_state;
    new_calls = es.calls;
    response = es.response;
  }</pre>
</div>
</div>
</li>
<li>
<p>The partial map <code>query_methods</code> of the <code>CanisterModule</code> is defined for all method names <code>method</code> for which the WebAssembly program exports a function <code>f</code> named <code>canister_query &lt;method&gt;</code>, and has value</p>
<div class="literalblock">
<div class="content">
<pre>query_methods[method] = λ arg → λ wasm_state →
  let es = ref {empty_execution_state with
      wasm_state = wasm_state;
      params = { data = arg.data; caller = arg.caller; reject_code = 0; reject_message ""}
    }
  try func&lt;es&gt;() with Trap then Trap
  if es.calls ≠ () then Trap
  if es.response = NoResponse then Trap
  Return es.response;</pre>
</div>
</div>
<div class="paragraph">
<p>This formulation checks afterwards that the system calls <code>ic0.calls_simple</code> was not invoked; an implementation can of course trap already when these system calls have been invoked.</p>
</div>
<div class="paragraph">
<p>By construction, the (possibly) modified <code>es.wasm_state</code> is discarded.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_helper_functions">Helper functions</h4>
<div class="paragraph">
<p>In the following section, we use the these helper functions</p>
</div>
<div class="paragraph">
<p>copy_to_canister&lt;es&gt;(dst : i32, offset : i32, size : i32, data : blob) =
  if offset+size &gt; |data| then Trap
  if dst+size &gt; |es.wasm_state.store.mem| then Trap
  es.wasm_state.store.mem[dst..dst+size] := data[offset..offset+size]</p>
</div>
<div class="paragraph">
<p>copy_from_canister&lt;es&gt;(src : i32, size : i32) blob =
  if src+size &gt; |es.wasm_state.store.mem| then Trap
  return es.wasm_state.store.mem[src..src+size]</p>
</div>
</div>
<div class="sect3">
<h4 id="_system_imports">System imports</h4>
<div class="paragraph">
<p>Upon <em>instantiation</em> of the WebAssembly module, we can provide the following functions as imports.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ic0.msg_arg_data_size&lt;es&gt;() : i32 =
  if es.params.data = NoData then Trap
  return |es.params.arg|

ic0.msg_arg_data_copy&lt;es&gt;(dst:i32, offset:i32, size:i32) =
  if es.params.data = NoData then Trap
  copy_to_canister&lt;es&gt;(dst, offset, size, es.param.arg)

ic0.msg_caller_size() : i32 =
  if es.params.caller = NoCaller then Trap
  return |es.params.caller|

ic0.msg_caller_copy(dst:i32, offset:i32, size:i32) : i32 =
  if es.params.caller = NoCaller then Trap
  copy_to_canister&lt;es&gt;(dst, offset, size, es.params.caller)

ic0.msg_reject_code&lt;es&gt;() : i32 =
  es.params.reject_code

ic0.msg_reject_msg_size&lt;es&gt;() : i32 =
  if es.reject_code = 0 then Trap
  return |es.params.reject_msg|

ic0.msg_reject_msg_copy&lt;es&gt;(dst:i32, offset:i32, size:i32) : i32 =
  if es.reject_code = 0 then Trap
  copy_to_canister&lt;es&gt;(dst, offset, size, es.params.reject_msg)

ic0.msg_reply_data_append&lt;es&gt;(src : i32, size : i32) =
  if es.response ≠ NoResponse then Trap
  es.reply_params.arg := es.reply_params.arg · copy_from_canister&lt;es&gt;(src, size)

ic0.msg_reply&lt;es&gt;() =
  if es.response ≠ NoResponse then Trap
  es.response := Reply (es.reply_params.arg)

ic0.msg_reject&lt;es&gt;(src : i32, size : i32) =
  if es.response ≠ NoResponse then Trap
  es.response := Reject (CANISTER_REJECT, copy_from_canister&lt;es&gt;(src, size))

ic0.canister_self_size&lt;es&gt;() : i32 =
  return |es.wasm_state.self_id|

ic0.canister_self_copy(dst:i32, offset:i32, size:i32)  =
  copy_to_canister&lt;es&gt;(dst, offset, size, es.wasm_state.self_id)

ic0.call_simple&lt;es&gt;(
    callee_src  : i32,
    callee_size : i32,
    name_src    : i32,
    name_size   : i32,
    reply_fun   : i32,
    reply_env   : i32,
    reject_fun  : i32,
    reject_env  : i32,
    data_src    : i32,
    data_size   : i32) =

  callee := copy_from_canister&lt;es&gt;(callee_src, callee_size);
  method_name := copy_from_canister&lt;es&gt;(name_src, name_size);
  arg := copy_from_canister&lt;es&gt;(data_src, data_size);

  if reply_fun &gt; |es.wasm_state.store.table| then Trap
  if typeof(es.wasm_state.store.table[reply_fun]) ≠ func (anyref, i32) -&gt; () then Trap
  on_reply := es.wasm_state.store.table[reply_fun]

  if reject_fun &gt; |es.wasm_state.store.table| then Trap
  if typeof(es.wasm_state.store.table[reject_fun]) ≠ func (anyref, i32) -&gt; () then Trap
  on_reject := es.wasm_state.store.table[reject_fun]

  let build_callback (params, func, env) =
    λ (self_id, wasm_state) →
      let es' = ref {empty_execution_state with
          wasm_state = wasm_state;
          self_id = self_id;
          params = params
        }
      try func&lt;es&gt;(env) with Trap then Trap
      Return {
        new_state = es'.wasm_state;
        new_calls = es'.performed_calls;
        response = es'.response;
      }

  if arbitrary()
  then
    return 1
  or
    es.calls := es.calls ·
      {
        callee = callee;
        method_name = method_name;
        arg = arg;
        callback = λ response → match response with
          Reply blob → build_callback
              ( { data = blob; caller = NoCaller; reject_code = 0 }
              , on_reply , reply_env )
          Reject (reject_code, _message) → build_callback
              ( { data = NoData; caller = NoCaller; reject_code = reject_code }
              , on_reject , eject_env )
      }
    return 0

ic0.stable_size&lt;es&gt;() -&gt; (page_count : i32) =
  return |es.wasm_state.stable_mem| / 64k

ic0.stable_grow&lt;es&gt;(new_pages : i32) -&gt; (old_page_count : i32) =
  if arbitrary()
  then return -1
  else
    old_size := |es.wasm_state.stable_mem| / 64k
    es.wasm_state.stable_mem :=
      es.wasm_state.stable_mem · repeat(0x00, new_pages * 64k)
    return old_size

ic0.stable_write&lt;es&gt;(offset : i32, src : i32, size : i32) -&gt; ()
  if src+size &gt; |es.wasm_state.store.mem| then Trap
  if offset+size &gt; |es.wasm_state.stable_mem| then Trap

  es.wasm_state.stable_mem[offset..offset+size] := es.wasm_state.store.mem[src..src+size]

ic0.stable_read&lt;es&gt;(dst : i32, offset : i32, size : i32) &gt; ()
  if offset+size &gt; |es.wasm_state.stable_mem| then Trap
  if dst+size &gt; |es.wasm_state.store.mem| then Trap

  es.wasm_state.store.mem[offset..offset+size] := es.wasm_state.stable.mem[src..src+size]

ic0.debug_print&lt;es&gt;(src : i32, size : i32) =
  return

ic0.trap&lt;es&gt;(src : i32, size : i32) =
  Trap</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="changelog">Changelog</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="v0_3">0.3 (unreleased)</h3>
<div class="ulist">
<ul>
<li>
<p>Spec: Users can use ECDSA in addition to Ed25519 to sign their requests.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="v0_2_0_4">0.2.0.4 (unreleased)</h3>
<div class="ulist">
<ul>
<li>
<p>ic-ref(-test): Enforce signatures checking</p>
</li>
<li>
<p>ic-ref(-test): Desired canister ids must be derived from sender</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="v0_2_0_2">0.2.0.2 (2020-03-19)</h3>
<div class="ulist">
<ul>
<li>
<p>ic-ref: Return status 202, empty body, on <code>submit</code>, to match spec</p>
</li>
<li>
<p>ic-ref: Allow update or inter-canister calls to query methods</p>
</li>
<li>
<p>ic-ref: Trap upon calls from queries</p>
</li>
<li>
<p>ic-ref-test: If the IC does not claim to be spec compliant, always succeed
(but still report errors)</p>
</li>
<li>
<p>ic-ref-test: Support --html reports</p>
</li>
<li>
<p>ic-ref-test: Use the “Universal Canister” to drive tests; more tests.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="v0_2_0_0">0.2.0.0 (2020-03-11)</h3>
<div class="ulist">
<ul>
<li>
<p>This is the first release. Subsequent releases will include a changelog.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-03-20 12:10:16 CET
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>